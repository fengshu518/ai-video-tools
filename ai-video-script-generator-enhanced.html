<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè§†é¢‘è„šæœ¬ç”Ÿæˆå·¥å…· - ä¿®å¤ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .main-content {
            padding: 30px;
        }

        .api-settings {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input, select, button, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .button-group button {
            flex: 1;
        }

        .success-message, .error-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .api-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected { background: #28a745; }
        .status-disconnected { background: #dc3545; }
        .status-testing {
            background: #ffc107;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .script-output {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            margin-bottom: 20px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .debug-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            color: #0066cc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tab-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .tab-btn {
            background: transparent;
            color: #6c757d;
            border: none;
            padding: 12px 24px;
            border-radius: 8px 8px 0 0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: -2px;
        }

        .tab-btn:hover {
            background: #f8f9fa;
            color: #667eea;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom: 2px solid #667eea;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* åŠ¨æ¼«ä¸“ç”¨æ ·å¼ */
        .anime-feature {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
        }

        .story-section {
            background: #f8f9fa;
            border-left: 4px solid #ff6b6b;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 0 10px 10px 0;
        }

        .shot-preview {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .shot-preview:hover {
            border-color: #ff6b6b;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.2);
        }

        .shot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .shot-number {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .shot-duration {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }

        .anime-output {
            background: #fff5f5;
            border: 2px solid #ffe0e0;
            border-radius: 10px;
            padding: 20px;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .sora-export-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .sora-export-btn:hover {
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .anime-tips {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* å•ä¸ªåˆ†é•œå¤åˆ¶æŒ‰é’®æ ·å¼ */
        .shot-actions {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
        }

        .copy-shot-btn {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .copy-shot-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 10px rgba(108, 117, 125, 0.3);
        }

        .copy-shot-btn:active {
            transform: translateY(0);
        }

        .copy-shot-btn.copied {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        /* ç”µå•†å¸¦è´§ä¸“ç”¨æ ·å¼ */
        .ecommerce-feature {
            background: linear-gradient(135deg, #ff9ff3 0%, #feca57 100%);
        }

        .ecommerce-tips {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .product-highlight {
            background: linear-gradient(135deg, #ff6b9d 0%, #feca57 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
            display: inline-block;
        }

        .ecommerce-output {
            background: #fff0f6;
            border: 2px solid #ffc2d1;
            border-radius: 10px;
            padding: 20px;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .ecommerce-shot {
            background: white;
            border: 2px solid #ffc2d1;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
            position: relative;
        }

        .ecommerce-shot:hover {
            border-color: #ff6b9d;
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.2);
        }

        .product-tag {
            position: absolute;
            top: -10px;
            right: 10px;
            background: linear-gradient(135deg, #ff6b9d 0%, #feca57 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .ecommerce-export-btn {
            background: linear-gradient(135deg, #ff6b9d 0%, #feca57 100%);
        }

        .ecommerce-export-btn:hover {
            box-shadow: 0 10px 20px rgba(255, 107, 157, 0.3);
        }

        /* ä¼ ç»Ÿåˆ†é•œä¸“ç”¨æ ·å¼ */
        .script-feature {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .script-tips {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            color: #1565c0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .script-shot {
            background: white;
            border: 2px solid #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
            position: relative;
        }

        .script-shot:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .script-tag {
            position: absolute;
            top: -10px;
            right: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .script-overview {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 0 10px 10px 0;
        }

        .script-output-enhanced {
            background: #f0f4ff;
            border: 2px solid #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        /* ç¾å¦†æ•™ç¨‹ä¸“ç”¨æ ·å¼ */
        .beauty-feature {
            background: linear-gradient(135deg, #ff6ec7 0%, #ff9a9e 100%);
        }

        .beauty-tips {
            background: #fff0f5;
            border: 1px solid #ffb6c1;
            color: #c71585;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .beauty-highlight {
            background: linear-gradient(135deg, #ff6ec7 0%, #ff9a9e 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
            display: inline-block;
        }

        .beauty-output {
            background: #fef4ff;
            border: 2px solid #ffdbed;
            border-radius: 10px;
            padding: 20px;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .beauty-shot {
            background: white;
            border: 2px solid #ffdbed;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
            position: relative;
        }

        .beauty-shot:hover {
            border-color: #ff6ec7;
            box-shadow: 0 5px 15px rgba(255, 110, 199, 0.2);
        }

        .beauty-tag {
            position: absolute;
            top: -10px;
            right: 10px;
            background: linear-gradient(135deg, #ff6ec7 0%, #ff9a9e 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .beauty-export-btn {
            background: linear-gradient(135deg, #ff6ec7 0%, #ff9a9e 100%);
        }

        .beauty-export-btn:hover {
            box-shadow: 0 10px 20px rgba(255, 110, 199, 0.3);
        }

        .beauty-overview {
            background: #f8f9fa;
            border-left: 4px solid #ff6ec7;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 0 10px 10px 0;
        }

        .step-number {
            background: linear-gradient(135deg, #ff6ec7 0%, #ff9a9e 100%);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¬ AIè§†é¢‘è„šæœ¬ç”Ÿæˆå·¥å…· - å·…å³°ç‰ˆ</h1>
            <p>ä¼ ç»Ÿåˆ†é•œ + AIåŠ¨æ¼«æ•…äº‹ + æç¬‘ç”µå•†å¸¦è´§ + ç¾å¦†æ•™ç¨‹ï¼Œå…¨æ–¹ä½è§†é¢‘åˆ›ä½œå¹³å°</p>
        </header>

        <div class="main-content">
            <!-- åŠŸèƒ½åˆ‡æ¢æ ‡ç­¾ -->
            <div class="tab-container" style="margin-bottom: 30px;">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('script')">ğŸ¬ ä¼ ç»Ÿåˆ†é•œè„šæœ¬</button>
                    <button class="tab-btn" onclick="switchTab('anime')">ğŸŒ AIåŠ¨æ¼«æ•…äº‹</button>
                    <button class="tab-btn" onclick="switchTab('ecommerce')">ğŸ›’ æç¬‘ç”µå•†å¸¦è´§</button>
                    <button class="tab-btn" onclick="switchTab('beauty')">ğŸ’„ ç¾å¦†æ•™ç¨‹å¸¦è´§</button>
                </div>
            </div>

            <!-- APIè®¾ç½®åŒºåŸŸ -->
            <div class="api-settings">
                <h2>ğŸ”‘ APIè®¾ç½®</h2>

                <div class="form-group">
                    <label>APIæä¾›å•†</label>
                    <select id="apiProvider" onchange="updateApiSettings()">
                        <option value="siliconflow">ç¡…åŸºæµåŠ¨ SiliconFlow (æ¨è)</option>
                        <option value="zhipu">æ™ºè°±AI GLM</option>
                        <option value="local">æœ¬åœ°æ¨¡æ‹Ÿæ¨¡å¼</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„API Key" onchange="validateApiKey()">
                    <div class="button-group">
                        <button onclick="testApiConnection()">ğŸ”— æµ‹è¯•è¿æ¥</button>
                        <button onclick="debugTestApi()" style="background: #28a745;">ğŸ› è°ƒè¯•æµ‹è¯•</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>è¿æ¥çŠ¶æ€</label>
                    <div id="connectionStatus">
                        <span class="api-status status-disconnected"></span>
                        <span id="statusText">æœªè¿æ¥</span>
                    </div>
                </div>

                <div id="apiInfo" class="debug-info">
                    <strong>ğŸ“‹ APIä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                    <span id="providerInfo">é€‰æ‹©APIæä¾›å•†æŸ¥çœ‹è¯´æ˜</span>
                </div>
            </div>

            <!-- ä¼ ç»Ÿåˆ†é•œè„šæœ¬åŠŸèƒ½ -->
            <div id="scriptTab" class="tab-content active">
                <!-- ä¼ ç»Ÿåˆ†é•œæç¤ºä¿¡æ¯ -->
                <div class="script-tips">
                    <strong>ğŸ¬ ä¼ ç»Ÿåˆ†é•œè„šæœ¬ç”Ÿæˆå™¨ï¼š</strong><br>
                    ä¸“ä¸šçš„è§†é¢‘åˆ†é•œè„šæœ¬ç”Ÿæˆå·¥å…·ï¼Œé€‚ç”¨äºå„ç±»çŸ­è§†é¢‘åˆ¶ä½œã€‚æ¯ä¸ªåˆ†é•œéƒ½æœ‰ç‹¬ç«‹çš„æ¡†æ¶å’Œå¤åˆ¶åŠŸèƒ½ï¼Œæ–¹ä¾¿æ‚¨çµæ´»ä½¿ç”¨ã€‚
                </div>

                <!-- è„šæœ¬ç”ŸæˆåŒºåŸŸ -->
                <div class="api-settings script-feature">
                    <h2>ğŸ“ è„šæœ¬ç”Ÿæˆè®¾ç½®</h2>

                    <div class="form-group">
                        <label>è§†é¢‘å…³é”®è¯</label>
                        <input type="text" id="keyword" placeholder="ä¾‹å¦‚ï¼šä»™ä¾ åŠ¨ç”»ã€å¥èº«å‡è‚¥ã€ç¾é£Ÿåˆ¶ä½œ">
                    </div>

                    <div class="form-group">
                        <label>åˆ†é•œæ•°é‡</label>
                        <select id="shotCount">
                            <option value="3">3ä¸ªåˆ†é•œ</option>
                            <option value="5">5ä¸ªåˆ†é•œ</option>
                            <option value="7">7ä¸ªåˆ†é•œ</option>
                            <option value="9" selected>9ä¸ªåˆ†é•œï¼ˆæ¨èï¼‰</option>
                        </select>
                    </div>

                    <button onclick="generateScript()" style="width: 100%; padding: 15px; font-size: 18px;">
                        âœ¨ ç”Ÿæˆè„šæœ¬
                    </button>
                </div>

                <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
                <div id="successMessage" class="success-message"></div>
                <div id="errorMessage" class="error-message"></div>

                <!-- è„šæœ¬è¾“å‡ºåŒºåŸŸ -->
                <div id="scriptOutput" style="display: none;">
                    <!-- è„šæœ¬æ¦‚è§ˆ -->
                    <div class="script-overview">
                        <h3>ğŸ“Š è„šæœ¬æ¦‚è§ˆ</h3>
                        <div id="scriptOverview" class="script-overview-content"></div>
                    </div>

                    <!-- åˆ†é•œé¢„è§ˆ -->
                    <h3>ğŸ¬ åˆ†é•œé¢„è§ˆ</h3>
                    <div id="scriptShotPreview" class="script-shot-container"></div>

                    <!-- å®Œæ•´è„šæœ¬è¾“å‡º -->
                    <h3>ğŸ“„ å®Œæ•´è„šæœ¬</h3>
                    <div id="scriptOutputEnhanced" class="script-output-enhanced"></div>

                    <!-- ä¼ ç»Ÿåˆ†é•œä¸“ç”¨å¯¼å‡ºæŒ‰é’® -->
                    <div id="scriptExportButtons" class="export-buttons">
                        <button onclick="copyScript()">ğŸ“‹ å¤åˆ¶è„šæœ¬</button>
                        <button onclick="downloadScript()">ğŸ’¾ ä¸‹è½½è„šæœ¬</button>
                        <button onclick="copyForSora()">ğŸ¬ å¤åˆ¶Soraæ ¼å¼</button>
                        <button onclick="copyScriptShots()" style="background: #17a2b8;">ğŸ“¤ å¤åˆ¶åˆ†é•œ</button>
                    </div>
                </div>
            </div>

            <!-- AIåŠ¨æ¼«æ•…äº‹åŠŸèƒ½ -->
            <div id="animeTab" class="tab-content">
                <!-- åŠ¨æ¼«æç¤ºä¿¡æ¯ -->
                <div class="anime-tips">
                    <strong>ğŸŒ AIåŠ¨æ¼«æ•…äº‹ç”Ÿæˆå™¨ï¼š</strong><br>
                    ä¸“ä¸ºSora2ä¼˜åŒ–çš„é•¿æ•…äº‹åˆ†é•œå·¥å…·ï¼Œè‡ªåŠ¨å°†1-2åˆ†é’Ÿçš„æ•…äº‹æ™ºèƒ½åˆ†å‰²æˆå¤šä¸ª10-15ç§’çš„è§†é¢‘ç‰‡æ®µï¼Œå®Œç¾é€‚é…Sora2çš„é™åˆ¶ã€‚
                </div>

                <!-- æ•…äº‹ç”ŸæˆåŒºåŸŸ -->
                <div class="api-settings anime-feature">
                    <h2>ğŸ“– æ•…äº‹ç”Ÿæˆè®¾ç½®</h2>

                    <div class="form-group">
                        <label>åŠ¨æ¼«æ•…äº‹ä¸»é¢˜</label>
                        <input type="text" id="animeKeyword" placeholder="ä¾‹å¦‚ï¼šé­”æ³•å°‘å¥³çš„å†’é™©ã€èµ›åšæœ‹å…‹ä¾¦æ¢ã€æ ¡å›­é’æ˜¥æ‹çˆ±">
                    </div>

                    <div class="form-group">
                        <label>æ•…äº‹ç±»å‹</label>
                        <select id="storyType">
                            <option value="adventure">å†’é™©å¥‡å¹»</option>
                            <option value="romance">é’æ˜¥æ‹çˆ±</option>
                            <option value="scifi">ç§‘å¹»æœªæ¥</option>
                            <option value="mystery">æ‚¬ç–‘æ¨ç†</option>
                            <option value="comedy">è½»æ¾æ—¥å¸¸</option>
                            <option value="action">çƒ­è¡€æˆ˜æ–—</option>
                            <option value="fantasy">å¼‚ä¸–ç•Œç©¿è¶Š</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>æ€»æ—¶é•¿</label>
                        <select id="totalDuration">
                            <option value="60">1åˆ†é’Ÿ</option>
                            <option value="90" selected>1.5åˆ†é’Ÿï¼ˆæ¨èï¼‰</option>
                            <option value="120">2åˆ†é’Ÿ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>åˆ†é•œæ—¶é•¿</label>
                        <select id="shotDuration">
                            <option value="10">10ç§’</option>
                            <option value="12" selected>12ç§’ï¼ˆæ¨èï¼‰</option>
                            <option value="15">15ç§’</option>
                        </select>
                    </div>

                    <button onclick="generateAnimeStory()" style="width: 100%; padding: 15px; font-size: 18px; background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);">
                        ğŸŒ ç”ŸæˆåŠ¨æ¼«æ•…äº‹
                    </button>
                </div>

                <!-- æ•…äº‹è¾“å‡ºåŒºåŸŸ -->
                <div id="storyOutput" style="display: none;">
                    <!-- æ•…äº‹æ¦‚è§ˆ -->
                    <div class="story-section">
                        <h3>ğŸ“š æ•…äº‹æ¦‚è§ˆ</h3>
                        <div id="storyOverview" class="story-overview"></div>
                    </div>

                    <!-- åˆ†é•œé¢„è§ˆ -->
                    <h3>ğŸ¬ åˆ†é•œé¢„è§ˆï¼ˆSora2ä¼˜åŒ–ï¼‰</h3>
                    <div id="shotPreview" class="shot-preview-container"></div>

                    <!-- å®Œæ•´è„šæœ¬è¾“å‡º -->
                    <h3>ğŸ“ å®Œæ•´è„šæœ¬</h3>
                    <div id="animeScriptOutput" class="anime-output"></div>

                    <!-- Sora2ä¸“ç”¨å¯¼å‡ºæŒ‰é’® -->
                    <div id="animeExportButtons" class="export-buttons">
                        <button onclick="copyAnimeScript()">ğŸ“‹ å¤åˆ¶å®Œæ•´è„šæœ¬</button>
                        <button onclick="downloadAnimeScript()">ğŸ’¾ ä¸‹è½½è„šæœ¬</button>
                        <button onclick="exportSora2Batch()" class="sora-export-btn">ğŸš€ æ‰¹é‡å¯¼å‡ºSora2</button>
                        <button onclick="copySingleShots()" style="background: #6f42c1;">ğŸ“¤ å¤åˆ¶å•ä¸ªåˆ†é•œ</button>
                    </div>
                </div>
            </div>

            <!-- æç¬‘ç”µå•†å¸¦è´§åŠŸèƒ½ -->
            <div id="ecommerceTab" class="tab-content">
                <!-- ç”µå•†æç¤ºä¿¡æ¯ -->
                <div class="ecommerce-tips">
                    <strong>ğŸ›’ æç¬‘ç”µå•†å¸¦è´§æ–‡æ¡ˆç”Ÿæˆå™¨ï¼š</strong><br>
                    ä¸“ä¸ºçŸ­è§†é¢‘å¹³å°è®¾è®¡çš„æç¬‘å¸¦è´§æ–‡æ¡ˆç”Ÿæˆå·¥å…·ï¼Œæ™ºèƒ½æ¤å…¥å•†å“ä¿¡æ¯ï¼Œè®©ç”¨æˆ·åœ¨æ¬¢ç¬‘ä¸­ä¸‹å•ï¼10-15ç§’å®Œç¾é€‚é…Sora2ã€‚
                </div>

                <!-- ç”µå•†ç”ŸæˆåŒºåŸŸ -->
                <div class="api-settings ecommerce-feature">
                    <h2>ğŸ›ï¸ å¸¦è´§æ–‡æ¡ˆè®¾ç½®</h2>

                    <div class="form-group">
                        <label>è§†é¢‘ä¸»é¢˜/åœºæ™¯</label>
                        <input type="text" id="ecommerceKeyword" placeholder="ä¾‹å¦‚ï¼šåŠå…¬å®¤æ—¥å¸¸ã€å®¶åº­è¶£äº‹ã€è¡—å¤´é‡‡è®¿">
                    </div>

                    <div class="form-group">
                        <label>å¸¦è´§å•†å“</label>
                        <input type="text" id="productInfo" placeholder="ä¾‹å¦‚ï¼šè“ç‰™è€³æœºã€é›¶é£Ÿå¤§ç¤¼åŒ…ã€æŠ¤è‚¤é¢è†œ">
                    </div>

                    <div class="form-group">
                        <label>æç¬‘é£æ ¼</label>
                        <select id="comedyStyle">
                            <option value="sarcasm">åè®½å¼æç¬‘</option>
                            <option value="exaggeration">å¤¸å¼ å¼æç¬‘</option>
                            <option value="misunderstanding">è¯¯ä¼šå¼æç¬‘</option>
                            <option value="comparison">å¯¹æ¯”å¼æç¬‘</option>
                            <option value="selfdeprecation">è‡ªå˜²å¼æç¬‘</option>
                            <option value="unexpected">åè½¬å¼æç¬‘</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>è§†é¢‘æ—¶é•¿</label>
                        <select id="ecommerceDuration">
                            <option value="10">10ç§’ï¼ˆæ¨èï¼‰</option>
                            <option value="12">12ç§’</option>
                            <option value="15">15ç§’</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ç›®æ ‡å¹³å°</label>
                        <select id="targetPlatform">
                            <option value="douyin">æŠ–éŸ³</option>
                            <option value="kuaishou">å¿«æ‰‹</option>
                            <option value="xiaohongshu">å°çº¢ä¹¦</option>
                            <option value="bilibili">Bç«™</option>
                        </select>
                    </div>

                    <button onclick="generateEcommerceScript()" style="width: 100%; padding: 15px; font-size: 18px; background: linear-gradient(135deg, #ff9ff3 0%, #feca57 100%);">
                        ğŸ›’ ç”Ÿæˆæç¬‘å¸¦è´§æ–‡æ¡ˆ
                    </button>
                </div>

                <!-- ç”µå•†è¾“å‡ºåŒºåŸŸ -->
                <div id="ecommerceOutput" style="display: none;">
                    <!-- æ–‡æ¡ˆæ¦‚è§ˆ -->
                    <div class="story-section">
                        <h3>ğŸ“ æ–‡æ¡ˆæ¦‚è§ˆ</h3>
                        <div id="ecommerceOverview" class="ecommerce-overview"></div>
                    </div>

                    <!-- åˆ†é•œé¢„è§ˆ -->
                    <h3>ğŸ¬ åˆ†é•œè„šæœ¬ï¼ˆå¸¦è´§ä¼˜åŒ–ï¼‰</h3>
                    <div id="ecommerceShotPreview" class="ecommerce-shot-container"></div>

                    <!-- å®Œæ•´æ–‡æ¡ˆè¾“å‡º -->
                    <h3>ğŸ“„ å®Œæ•´å¸¦è´§æ–‡æ¡ˆ</h3>
                    <div id="ecommerceScriptOutput" class="ecommerce-output"></div>

                    <!-- ç”µå•†ä¸“ç”¨å¯¼å‡ºæŒ‰é’® -->
                    <div id="ecommerceExportButtons" class="export-buttons">
                        <button onclick="copyEcommerceScript()">ğŸ“‹ å¤åˆ¶æ–‡æ¡ˆ</button>
                        <button onclick="downloadEcommerceScript()">ğŸ’¾ ä¸‹è½½æ–‡æ¡ˆ</button>
                        <button onclick="exportEcommerceSora()" class="ecommerce-export-btn">ğŸ›ï¸ å¯¼å‡ºSora2æ ¼å¼</button>
                        <button onclick="copyEcommerceShots()" style="background: #e83e8c;">ğŸ“¤ å¤åˆ¶åˆ†é•œ</button>
                    </div>
                </div>
            </div>

            <!-- ç¾å¦†æ•™ç¨‹å¸¦è´§åŠŸèƒ½ -->
            <div id="beautyTab" class="tab-content">
                <!-- ç¾å¦†æç¤ºä¿¡æ¯ -->
                <div class="beauty-tips">
                    <strong>ğŸ’„ ç¾å¦†æ•™ç¨‹å¸¦è´§ç”Ÿæˆå™¨ï¼š</strong><br>
                    ä¸“ä¸šçš„ç¾å¦†æ•™ç¨‹è§†é¢‘è„šæœ¬ç”Ÿæˆå·¥å…·ï¼Œæ¶µç›–åŒ–å¦†æŠ€å·§ã€å‘å‹æ•™ç¨‹ã€æŠ¤è‚¤æ­¥éª¤ç­‰ã€‚æ¯ä¸ªæ­¥éª¤éƒ½æœ‰è¯¦ç»†æ¼”ç¤ºï¼Œè‡ªç„¶æ¤å…¥ç¾å¦†äº§å“ï¼Œå®Œç¾é€‚é…Sora2ç”Ÿæˆæ•™å­¦è§†é¢‘ï¼
                </div>

                <!-- ç¾å¦†ç”ŸæˆåŒºåŸŸ -->
                <div class="api-settings beauty-feature">
                    <h2>ğŸ’„ ç¾å¦†æ•™ç¨‹è®¾ç½®</h2>

                    <div class="form-group">
                        <label>ç¾å¦†æ•™ç¨‹ä¸»é¢˜</label>
                        <input type="text" id="beautyKeyword" placeholder="ä¾‹å¦‚ï¼šç«æ¯›å¤¹ä½¿ç”¨æ•™ç¨‹ã€æ—¥å¸¸å¦†å®¹æ­¥éª¤ã€éŸ©å¼ç¼–å‘ã€çœ¼å½±ç”»æ³•">
                    </div>

                    <div class="form-group">
                        <label>æ•™ç¨‹ç±»å‹</label>
                        <select id="beautyType">
                            <option value="makeup">åŒ–å¦†æ•™ç¨‹</option>
                            <option value="hair">å‘å‹æ•™ç¨‹</option>
                            <option value="skincare">æŠ¤è‚¤æ•™ç¨‹</option>
                            <option value="tools">ç¾å¦†å·¥å…·ä½¿ç”¨</option>
                            <option value="nails">ç¾ç”²æ•™ç¨‹</option>
                            <option value="eyebrows">çœ‰æ¯›ä¿®æ•´</option>
                            <option value="lips">å”‡å¦†æŠ€å·§</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>å¸¦è´§äº§å“</label>
                        <input type="text" id="beautyProduct" placeholder="ä¾‹å¦‚ï¼šç«æ¯›å¤¹ã€çœ¼å½±ç›˜ã€ç²‰åº•æ¶²ã€å‘å¤¹ã€é¢è†œï¼ˆå¯é€‰ï¼‰">
                    </div>

                    <div class="form-group">
                        <label>æ•™ç¨‹éš¾åº¦</label>
                        <select id="beautyLevel">
                            <option value="beginner">æ–°æ‰‹å…¥é—¨</option>
                            <option value="intermediate">è¿›é˜¶æŠ€å·§</option>
                            <option value="advanced">ä¸“ä¸šå¦†å®¹</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>è§†é¢‘æ—¶é•¿</label>
                        <select id="beautyDuration">
                            <option value="30">30ç§’ï¼ˆå¿«é€Ÿæ•™ç¨‹ï¼‰</option>
                            <option value="60" selected>1åˆ†é’Ÿï¼ˆæ ‡å‡†æ•™ç¨‹ï¼‰</option>
                            <option value="90">1.5åˆ†é’Ÿï¼ˆè¯¦ç»†æ•™ç¨‹ï¼‰</option>
                            <option value="120">2åˆ†é’Ÿï¼ˆå®Œæ•´æ•™ç¨‹ï¼‰</option>
                        </select>
                    </div>

                    <button onclick="generateBeautyScript()" style="width: 100%; padding: 15px; font-size: 18px; background: linear-gradient(135deg, #ff6ec7 0%, #ff9a9e 100%);">
                        ğŸ’„ ç”Ÿæˆç¾å¦†æ•™ç¨‹
                    </button>
                </div>

                <!-- ç¾å¦†è¾“å‡ºåŒºåŸŸ -->
                <div id="beautyOutput" style="display: none;">
                    <!-- æ•™ç¨‹æ¦‚è§ˆ -->
                    <div class="beauty-overview">
                        <h3>ğŸ’… æ•™ç¨‹æ¦‚è§ˆ</h3>
                        <div id="beautyOverview" class="beauty-overview-content"></div>
                    </div>

                    <!-- æ­¥éª¤é¢„è§ˆ -->
                    <h3>ğŸ“ æ•™ç¨‹æ­¥éª¤</h3>
                    <div id="beautyShotPreview" class="beauty-shot-container"></div>

                    <!-- å®Œæ•´æ•™ç¨‹è¾“å‡º -->
                    <h3>ğŸ“„ å®Œæ•´æ•™ç¨‹è„šæœ¬</h3>
                    <div id="beautyScriptOutput" class="beauty-output"></div>

                    <!-- ç¾å¦†ä¸“ç”¨å¯¼å‡ºæŒ‰é’® -->
                    <div id="beautyExportButtons" class="export-buttons">
                        <button onclick="copyBeautyScript()">ğŸ“‹ å¤åˆ¶æ•™ç¨‹</button>
                        <button onclick="downloadBeautyScript()">ğŸ’¾ ä¸‹è½½æ•™ç¨‹</button>
                        <button onclick="exportBeautySora()" class="beauty-export-btn">ğŸ’… å¯¼å‡ºSora2æ ¼å¼</button>
                        <button onclick="copyBeautyShots()" style="background: #e91e63;">ğŸ“¤ å¤åˆ¶æ­¥éª¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentScript = '';
        let currentScriptData = null;
        let currentAnimeStory = null;
        let currentEcommerceScript = null;
        let currentBeautyScript = null;
        let apiConfig = {
            provider: 'siliconflow',
            apiKey: '',
            baseUrl: '',
            model: ''
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
            updateApiSettings();
            loadSavedApiKey();
        });

        // æ›´æ–°APIè®¾ç½®
        function updateApiSettings() {
            const provider = document.getElementById('apiProvider').value;
            const apiInfo = document.getElementById('providerInfo');

            apiConfig.provider = provider;

            if (provider === 'siliconflow') {
                apiConfig.baseUrl = 'https://api.siliconflow.cn/v1';
                apiInfo.innerHTML = `
                    <strong>ğŸ”¥ ç¡…åŸºæµåŠ¨ SiliconFlow ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                    1. ğŸŒŸ <strong><a href="https://cloud.siliconflow.cn/i/eKkAxOod" target="_blank" style="color: #ff6ec7; font-weight: bold; text-decoration: underline;">ç‚¹å‡»è¿™é‡Œæ³¨å†Œç¡…åŸºæµåŠ¨è´¦å·</a></strong><br>
                    2. ğŸ”‘ åœ¨æ§åˆ¶å°è·å– API Keyï¼ˆæ ¼å¼ï¼šsk-xxxxï¼‰<br>
                    3. ğŸš€ æ”¯æŒå¤šç§ä¸­æ–‡æ¨¡å‹ï¼Œä»·æ ¼ä¼˜æƒ <br>
                    4. ğŸ’° <strong>çº¦ Â¥0.01/æ¬¡ï¼Œæ€§ä»·æ¯”è¶…é«˜ï¼Œé€‚åˆå¤§é‡ä½¿ç”¨</strong>
                `;
            } else if (provider === 'zhipu') {
                apiConfig.baseUrl = 'https://open.bigmodel.cn/api/paas/v4';
                apiInfo.innerHTML = `
                    <strong>ğŸ”¥ æ™ºè°±AI GLM ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                    1. ğŸŒŸ <strong><a href="https://www.bigmodel.cn/invite?icode=KvtsBvR%2F8Vn9XOYZy2luepmwcr074zMJTpgMb8zZZvg%3D" target="_blank" style="color: #ff6ec7; font-weight: bold; text-decoration: underline;">ç‚¹å‡»è¿™é‡Œæ³¨å†Œæ™ºè°±AIè´¦å·</a></strong><br>
                    2. ğŸ”‘ åœ¨ API å¯†é’¥é¡µé¢è·å– Keyï¼ˆæ ¼å¼ï¼šglm-xxxxï¼‰<br>
                    3. ğŸš€ æ™ºè°±è‡ªç ”æ¨¡å‹ï¼Œä¸­æ–‡ç†è§£èƒ½åŠ›å¼º<br>
                    4. ğŸ’° <strong>çº¦ Â¥0.1/æ¬¡ï¼Œè´¨é‡ç¨³å®šå¯é </strong>
                `;
            } else {
                apiConfig.baseUrl = '';
                apiInfo.innerHTML = `
                    <strong>æœ¬åœ°æ¨¡æ‹Ÿæ¨¡å¼ï¼š</strong><br>
                    ä½¿ç”¨é¢„è®¾çš„è„šæœ¬æ¨¡æ¿ï¼Œæ— éœ€ API Key<br>
                    é€‚åˆå¿«é€Ÿä½“éªŒå·¥å…·åŠŸèƒ½
                `;
                updateConnectionStatus('connected', 'å·²è¿æ¥ (æ¨¡æ‹Ÿ)');
            }

            validateApiKey();
        }

        // éªŒè¯API Key
        function validateApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const provider = document.getElementById('apiProvider').value;

            if (provider === 'local') {
                updateConnectionStatus('connected', 'å·²è¿æ¥ (æ¨¡æ‹Ÿ)');
                return true;
            }

            if (!apiKey) {
                updateConnectionStatus('disconnected', 'è¯·è¾“å…¥ API Key');
                return false;
            }

            if (provider === 'siliconflow' && apiKey.length < 20) {
                updateConnectionStatus('disconnected', 'API Key æ ¼å¼ä¸æ­£ç¡®');
                return false;
            }

            if (provider === 'zhipu' && !apiKey.startsWith('glm-')) {
                updateConnectionStatus('disconnected', 'æ™ºè°± API Key æ ¼å¼ä¸æ­£ç¡®');
                return false;
            }

            apiConfig.apiKey = apiKey;
            updateConnectionStatus('connected', 'å·²é…ç½®');
            return true;
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, text) {
            const statusSpan = document.querySelector('#connectionStatus .api-status');
            const textSpan = document.getElementById('statusText');

            statusSpan.className = `api-status status-${status}`;
            textSpan.textContent = text;

            console.log(`ğŸ”„ çŠ¶æ€æ›´æ–°: ${status} - ${text}`);
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            let messageElement;

            if (type === 'success') {
                messageElement = document.getElementById('successMessage');
                messageElement.textContent = `âœ… ${message}`;
            } else if (type === 'info') {
                messageElement = document.getElementById('successMessage'); // å¤ç”¨æˆåŠŸæ¶ˆæ¯å…ƒç´ 
                messageElement.textContent = `â„¹ï¸ ${message}`;
            } else {
                messageElement = document.getElementById('errorMessage');
                messageElement.textContent = `âŒ ${message}`;
            }

            messageElement.style.display = 'block';

            // éšè—å¦ä¸€ç§ç±»å‹çš„æ¶ˆæ¯
            const otherElement = document.getElementById(type === 'error' ? 'successMessage' : 'errorMessage');
            if (otherElement) {
                otherElement.style.display = 'none';
            }

            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }

        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            console.log('ğŸ”— æµ‹è¯•è¿æ¥å‡½æ•°è¢«è°ƒç”¨');

            const provider = document.getElementById('apiProvider').value;
            const apiKey = document.getElementById('apiKey').value.trim();

            console.log('ğŸ“‹ æµ‹è¯•å‚æ•°:', { provider, hasApiKey: !!apiKey });

            if (provider === 'local') {
                showMessage('æœ¬åœ°æ¨¡æ‹Ÿæ¨¡å¼ï¼Œæ— éœ€æµ‹è¯•è¿æ¥', 'success');
                updateConnectionStatus('connected', 'å·²è¿æ¥ (æ¨¡æ‹Ÿ)');
                return;
            }

            if (!apiKey) {
                showMessage('è¯·å…ˆè¾“å…¥ API Key', 'error');
                return;
            }

            updateConnectionStatus('testing', 'æµ‹è¯•ä¸­...');
            showMessage('æ­£åœ¨æµ‹è¯•APIè¿æ¥...', 'info');

            try {
                let testResult;
                if (provider === 'siliconflow') {
                    testResult = await testSiliconFlowApi();
                } else if (provider === 'zhipu') {
                    testResult = await testZhipuApi();
                }

                if (testResult.success) {
                    updateConnectionStatus('connected', 'è¿æ¥æˆåŠŸ');
                    showMessage('API è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
                } else {
                    updateConnectionStatus('disconnected', 'è¿æ¥å¤±è´¥');
                    showMessage(`API è¿æ¥å¤±è´¥ï¼š${testResult.error}`, 'error');
                }
            } catch (error) {
                updateConnectionStatus('disconnected', 'è¿æ¥å¤±è´¥');
                showMessage(`API è¿æ¥å¤±è´¥ï¼š${error.message}`, 'error');
                console.error('APIæµ‹è¯•å¼‚å¸¸:', error);
            }
        }

        // æµ‹è¯•ç¡…åŸºæµåŠ¨API
        async function testSiliconFlowApi() {
            try {
                const response = await fetch('https://api.siliconflow.cn/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'Qwen/Qwen2.5-72B-Instruct',
                        messages: [{ role: 'user', content: 'æµ‹è¯•è¿æ¥' }],
                        max_tokens: 5
                    })
                });

                if (response.ok) {
                    return { success: true };
                } else {
                    const error = await response.json().catch(() => ({}));
                    return { success: false, error: error.error?.message || response.statusText };
                }
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // æµ‹è¯•æ™ºè°±API
        async function testZhipuApi() {
            try {
                const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'glm-4',
                        messages: [{ role: 'user', content: 'æµ‹è¯•è¿æ¥' }],
                        max_tokens: 5
                    })
                });

                if (response.ok) {
                    return { success: true };
                } else {
                    const error = await response.json().catch(() => ({}));
                    return { success: false, error: error.error?.message || response.statusText };
                }
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // è°ƒè¯•æµ‹è¯•å‡½æ•°
        function debugTestApi() {
            console.log('ğŸ› è°ƒè¯•æµ‹è¯•APIå‡½æ•°è¢«è°ƒç”¨');

            try {
                // æ£€æŸ¥å¿…è¦å…ƒç´ 
                const provider = document.getElementById('apiProvider');
                const apiKey = document.getElementById('apiKey');
                const connectionStatus = document.getElementById('connectionStatus');

                console.log('ğŸ“‹ DOMå…ƒç´ æ£€æŸ¥:', {
                    provider: !!provider,
                    apiKey: !!apiKey,
                    connectionStatus: !!connectionStatus,
                    providerValue: provider?.value,
                    hasApiKey: !!apiKey?.value?.trim()
                });

                if (!provider || !apiKey || !connectionStatus) {
                    showMessage('ç¼ºå°‘å¿…è¦çš„DOMå…ƒç´ ', 'error');
                    return;
                }

                // æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
                console.log('ğŸ” å‡½æ•°æ£€æŸ¥:', {
                    testApiConnection: typeof testApiConnection,
                    testSiliconFlowApi: typeof testSiliconFlowApi,
                    testZhipuApi: typeof testZhipuApi
                });

                // ç›´æ¥è°ƒç”¨åŸå§‹å‡½æ•°
                console.log('ğŸ”„ è°ƒç”¨testApiConnectionå‡½æ•°...');
                if (typeof testApiConnection === 'function') {
                    testApiConnection();
                } else {
                    showMessage('testApiConnectionå‡½æ•°ä¸å­˜åœ¨', 'error');
                }

            } catch (error) {
                console.error('ğŸ’¥ è°ƒè¯•æµ‹è¯•å‡ºé”™:', error);
                showMessage(`è°ƒè¯•æµ‹è¯•å‡ºé”™: ${error.message}`, 'error');
            }
        }

        // ç”Ÿæˆè„šæœ¬
        async function generateScript() {
            const keyword = document.getElementById('keyword').value.trim();
            const shotCount = parseInt(document.getElementById('shotCount').value);

            if (!keyword) {
                showMessage('è¯·è¾“å…¥è§†é¢‘å…³é”®è¯', 'error');
                return;
            }

            const provider = document.getElementById('apiProvider').value;
            if (provider !== 'local' && !apiConfig.apiKey) {
                showMessage('è¯·å…ˆé…ç½®API Key', 'error');
                return;
            }

            // ç¦ç”¨ç”ŸæˆæŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            const generateBtn = document.querySelector('button[onclick="generateScript()"]');
            generateBtn.disabled = true;
            generateBtn.textContent = 'â³ ç”Ÿæˆä¸­...';

            try {
                showMessage('æ­£åœ¨ç”ŸæˆAIå†…å®¹...', 'info');

                if (provider === 'local') {
                    // æœ¬åœ°æ¨¡æ‹Ÿæ¨¡å¼
                    currentScript = generateMockScript(keyword, shotCount);
                } else {
                    // AIç”Ÿæˆæ¨¡å¼
                    currentScript = await generateAIScript(keyword, shotCount);
                }

                displayScript(currentScript);
                showMessage(`âœ… æˆåŠŸç”Ÿæˆ ${shotCount} ä¸ªåˆ†é•œçš„AIè„šæœ¬ï¼`, 'success');

            } catch (error) {
                console.error('AIç”Ÿæˆå¤±è´¥:', error);
                showMessage(`âŒ ç”Ÿæˆå¤±è´¥ï¼š${error.message}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                generateBtn.disabled = false;
                generateBtn.textContent = 'âœ¨ ç”Ÿæˆè„šæœ¬';
            }
        }

        // AIç”Ÿæˆè„šæœ¬
        async function generateAIScript(keyword, shotCount) {
            const prompt = buildAIPrompt(keyword, shotCount);

            console.log('ğŸ¤– å¼€å§‹AIç”Ÿæˆè„šæœ¬:', { keyword, shotCount, provider: apiConfig.provider });

            const response = await fetch(`${apiConfig.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiConfig.apiKey}`
                },
                body: JSON.stringify({
                    model: getChatModel(),
                    messages: [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è§†é¢‘è„šæœ¬åˆ›ä½œè€…ï¼Œæ“…é•¿æ ¹æ®å…³é”®è¯åˆ›ä½œé«˜è´¨é‡çš„åˆ†é•œè„šæœ¬ã€‚'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 2000,
                    temperature: 0.8
                })
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(`AIç”Ÿæˆå¤±è´¥ (${response.status}): ${error.error?.message || response.statusText}`);
            }

            const data = await response.json();
            const aiContent = data.choices?.[0]?.message?.content || '';

            if (!aiContent) {
                throw new Error('AIè¿”å›å†…å®¹ä¸ºç©º');
            }

            console.log('âœ… AIç”ŸæˆæˆåŠŸ:', aiContent.length, 'å­—ç¬¦');

            // æ ¼å¼åŒ–AIç”Ÿæˆçš„å†…å®¹
            return formatAIScript(aiContent, keyword, shotCount);
        }

        // æ„å»ºAIæç¤ºè¯
        function buildAIPrompt(keyword, shotCount) {
            return `è¯·ä¸º"${keyword}"è¿™ä¸ªä¸»é¢˜åˆ›ä½œä¸€ä¸ªä¸“ä¸šçš„15ç§’çŸ­è§†é¢‘åˆ†é•œè„šæœ¬ã€‚

è¦æ±‚ï¼š
1. è§†é¢‘ä¸»é¢˜ï¼š${keyword}
2. æ€»æ—¶é•¿ï¼š15ç§’
3. åˆ†é•œæ•°é‡ï¼š${shotCount}ä¸ªåˆ†é•œ
4. è¾“å‡ºæ ¼å¼ï¼šJSONç»“æ„åŒ–æ•°æ®

æ•…äº‹ç»“æ„è¦æ±‚ï¼š
- å¼€å¤´åˆ†é•œï¼šå¿«é€Ÿå¸å¼•è§‚ä¼—æ³¨æ„åŠ›
- å‘å±•åˆ†é•œï¼šå±•ç¤ºä¸»é¢˜æ ¸å¿ƒå†…å®¹
- ç»“å°¾åˆ†é•œï¼šæœ‰åŠ›æ”¶å°¾æˆ–è¡ŒåŠ¨å·å¬

è¯·æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
{
  "title": "å¸å¼•çœ¼çƒçš„è§†é¢‘æ ‡é¢˜",
  "keyword": "${keyword}",
  "totalDuration": 15,
  "shotCount": ${shotCount},
  "overview": "è§†é¢‘æ¦‚è§ˆï¼Œ50å­—ä»¥å†…",
  "shots": [
    {
      "number": 1,
      "title": "åˆ†é•œæ ‡é¢˜",
      "duration": è®¡ç®—å‡ºçš„ç§’æ•°,
      "timeRange": "0-Xç§’",
      "scene": "è¯¦ç»†çš„åœºæ™¯æè¿°",
      "action": "åŠ¨ä½œå’Œè¡¨æƒ…æè¿°",
      "visual": "è§†è§‰æ•ˆæœå’Œé•œå¤´è¯­è¨€",
      "audio": "éŸ³æ•ˆå’Œé…ä¹å»ºè®®",
      "transition": "ä¸ä¸‹ä¸€ä¸ªåˆ†é•œçš„è½¬åœºæ–¹å¼"
    }
  ]
}

æ¯ä¸ªåˆ†é•œåº”è¯¥åŒ…å«ï¼š
- é•œå¤´è¯­è¨€ï¼ˆç‰¹å†™ã€å…¨æ™¯ã€æ¨æ‹‰æ‘‡ç§»ç­‰ï¼‰
- å…·ä½“çš„åœºæ™¯æè¿°
- äººç‰©åŠ¨ä½œå’Œè¡¨æƒ…
- è§†è§‰æ•ˆæœè¯´æ˜
- éŸ³æ•ˆè®¾è®¡
- æ—¶é—´åˆ†é…ï¼ˆæ€»æ—¶é•¿15ç§’å¹³å‡åˆ†é…ï¼‰

è¯·ç¡®ä¿å†…å®¹åŸåˆ›ã€ä¸“ä¸šã€æœ‰åˆ›æ„ï¼Œé€‚åˆçŸ­è§†é¢‘å¹³å°ä¼ æ’­ã€‚`;
        }

        // è·å–èŠå¤©æ¨¡å‹
        function getChatModel() {
            if (apiConfig.provider === 'siliconflow') {
                return 'Qwen/Qwen2.5-72B-Instruct';
            } else if (apiConfig.provider === 'zhipu') {
                return 'glm-4';
            }
            return 'Qwen/Qwen2.5-72B-Instruct'; // é»˜è®¤æ¨¡å‹
        }

        // æ ¼å¼åŒ–AIç”Ÿæˆçš„è„šæœ¬
        function formatAIScript(aiContent, keyword, shotCount) {
            try {
                // å°è¯•è§£æJSONæ ¼å¼
                let scriptData;
                if (aiContent.includes('{') && aiContent.includes('}')) {
                    const jsonMatch = aiContent.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        scriptData = JSON.parse(jsonMatch[0]);
                    }
                }

                // å¦‚æœJSONè§£ææˆåŠŸï¼Œæ ¼å¼åŒ–è¾“å‡º
                if (scriptData && scriptData.shots) {
                    let formattedScript = `è§†é¢‘ä¸»é¢˜ï¼š${scriptData.title || keyword}
æŠ€æœ¯è§„æ ¼ï¼š4K 60FPS å†™å®æ¸²æŸ“ é«˜è´¨é‡
åˆ†é•œæ•°é‡ï¼š${scriptData.shotCount || shotCount}ä¸ª
æ€»æ—¶é•¿ï¼š15ç§’
ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}

è§†é¢‘æ¦‚è§ˆï¼š${scriptData.overview || 'ä¸“ä¸šçš„çŸ­è§†é¢‘å†…å®¹'}

`;

                    scriptData.shots.forEach(shot => {
                        formattedScript += `åˆ†é•œ ${shot.number}: ${shot.title}
æ—¶é—´: ${shot.timeRange || shot.duration + 'ç§’'}
ç”»é¢: ${shot.scene}
åŠ¨ä½œ: ${shot.action || shot.scene}
è§†è§‰: ${shot.visual}
éŸ³æ•ˆ: ${shot.audio}
è½¬åœº: ${shot.transition || 'è‡ªç„¶è¿‡æ¸¡'}

`;
                    });

                    return formattedScript;
                }
            } catch (error) {
                console.warn('JSONè§£æå¤±è´¥ï¼Œä½¿ç”¨æ–‡æœ¬æ ¼å¼:', error);
            }

            // å¦‚æœJSONè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘
            let formattedScript = `è§†é¢‘ä¸»é¢˜ï¼š${keyword}
æŠ€æœ¯è§„æ ¼ï¼š4K 60FPS å†™å®æ¸²æŸ“ é«˜è´¨é‡
åˆ†é•œæ•°é‡ï¼š${shotCount}ä¸ª
æ€»æ—¶é•¿ï¼š15ç§’
ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}

`;

            // æ¸…ç†å’Œæ ¼å¼åŒ–AIå†…å®¹
            let cleanedContent = aiContent
                .replace(/```[\s\S]*?```/g, '') // ç§»é™¤ä»£ç å—
                .replace(/^\s*è§†é¢‘ä¸»é¢˜[:ï¼š].*$/m, '') // ç§»é™¤é‡å¤çš„ä¸»é¢˜è¡Œ
                .replace(/^\s*æŠ€æœ¯è§„æ ¼[:ï¼š].*$/m, '') // ç§»é™¤é‡å¤çš„è§„æ ¼è¡Œ
                .trim();

            formattedScript += cleanedContent;

            return formattedScript;
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿè„šæœ¬
        function generateMockScript(keyword, shotCount) {
            const avgDuration = Math.floor(15 / shotCount);
            const shots = [];

            for (let i = 1; i <= shotCount; i++) {
                const startTime = (i - 1) * avgDuration;
                const endTime = i === shotCount ? 15 : i * avgDuration;
                const duration = endTime - startTime;

                let shotTitle, scene, action, visual, audio, transition;

                if (i === 1) {
                    // å¼€åœºåˆ†é•œ
                    shotTitle = 'å¼€åœºå¼•å…¥';
                    scene = `${keyword}ä¸»é¢˜çš„å¼€åœºåœºæ™¯ï¼Œå¿«é€Ÿå»ºç«‹èƒŒæ™¯`;
                    action = 'å¿«é€Ÿå±•ç¤ºä¸»é¢˜å…ƒç´ ï¼Œå¸å¼•è§‚ä¼—æ³¨æ„åŠ›';
                    visual = 'ç‰¹å†™é•œå¤´ï¼Œæ¸…æ™°çš„å¯¹ç„¦ï¼Œæ˜äº®çš„è‰²å½©';
                    audio = 'è½»å¿«çš„å¼€åœºéŸ³ä¹ï¼Œç¯å¢ƒéŸ³æ•ˆ';
                    transition = 'å¿«é€Ÿåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªåœºæ™¯';
                } else if (i === shotCount) {
                    // ç»“å°¾åˆ†é•œ
                    shotTitle = 'ç»“å°¾æ”¶æŸ';
                    scene = `${keyword}çš„æ€»ç»“æ€§åœºæ™¯`;
                    action = 'æœ‰åŠ›çš„æ”¶å°¾åŠ¨ä½œæˆ–è¡¨æƒ…';
                    visual = 'å…¨æ™¯æˆ–ç‰¹å†™ï¼Œå¼ºè°ƒä¸»é¢˜';
                    audio = 'æ¸å¼ºæˆ–æ¸å¼±éŸ³ä¹ï¼Œæ”¶å°¾éŸ³æ•ˆ';
                    transition = 'è‡ªç„¶ç»“æŸ';
                } else {
                    // ä¸­é—´åˆ†é•œ
                    shotTitle = `å‘å±•${i-1}`;
                    scene = `${keyword}çš„æ ¸å¿ƒå†…å®¹å±•ç¤º${i-1}`;
                    action = 'å±•ç¤ºå…³é”®åŠ¨ä½œå’Œæƒ…èŠ‚å‘å±•';
                    visual = 'å¤šè§’åº¦æ‹æ‘„ï¼ŒåŠ¨æ€é•œå¤´è¯­è¨€';
                    audio = 'èŠ‚å¥é…åˆçš„èƒŒæ™¯éŸ³ä¹';
                    transition = 'æµç•…è½¬åœº';
                }

                shots.push({
                    number: i,
                    title: shotTitle,
                    duration: duration,
                    timeRange: `${startTime}ç§’ - ${endTime}ç§’`,
                    scene: scene,
                    action: action,
                    visual: visual,
                    audio: audio,
                    transition: transition
                });
            }

            let script = `è§†é¢‘ä¸»é¢˜ï¼š${keyword} - ä¸“ä¸šå±•ç¤º
æŠ€æœ¯è§„æ ¼ï¼š4K 60FPS å†™å®æ¸²æŸ“ é«˜è´¨é‡
åˆ†é•œæ•°é‡ï¼š${shotCount}ä¸ª
æ€»æ—¶é•¿ï¼š15ç§’
ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}

è§†é¢‘æ¦‚è§ˆï¼šé€šè¿‡${shotCount}ä¸ªç²¾å¿ƒè®¾è®¡çš„åˆ†é•œï¼Œå…¨æ–¹ä½å±•ç¤º${keyword}çš„é­…åŠ›

`;

            shots.forEach(shot => {
                script += `åˆ†é•œ ${shot.number}: ${shot.title}
æ—¶é—´: ${shot.timeRange}
ç”»é¢: ${shot.scene}
åŠ¨ä½œ: ${shot.action}
è§†è§‰: ${shot.visual}
éŸ³æ•ˆ: ${shot.audio}
è½¬åœº: ${shot.transition}

`;
            });

            return script;
        }

        // æ˜¾ç¤ºè„šæœ¬
        function displayScript(script) {
            // è§£æè„šæœ¬ä¸ºç»“æ„åŒ–æ•°æ®
            const scriptData = parseScriptData(script);
            currentScriptData = scriptData;

            // æ˜¾ç¤ºè„šæœ¬æ¦‚è§ˆ
            const scriptOverview = document.getElementById('scriptOverview');
            scriptOverview.innerHTML = `
                <p><strong>ğŸ¬ è§†é¢‘ä¸»é¢˜ï¼š</strong>${scriptData.keyword}</p>
                <p><strong>ğŸ¯ åˆ†é•œæ•°é‡ï¼š</strong>${scriptData.shotCount}ä¸ª</p>
                <p><strong>â±ï¸ æ€»æ—¶é•¿ï¼š</strong>15ç§’</p>
                <p><strong>ğŸ“ è„šæœ¬ç±»å‹ï¼š</strong>ä¼ ç»Ÿåˆ†é•œè„šæœ¬</p>
            `;

            // æ˜¾ç¤ºåˆ†é•œé¢„è§ˆ
            const scriptShotPreview = document.getElementById('scriptShotPreview');
            scriptShotPreview.innerHTML = scriptData.shots.map(shot => `
                <div class="script-shot">
                    <div class="script-tag">åˆ†é•œ ${shot.number}</div>
                    <div class="shot-header">
                        <span class="shot-number">åˆ†é•œ ${shot.number}</span>
                        <span class="shot-duration">${shot.duration}ç§’</span>
                    </div>
                    <h4>${shot.title}</h4>
                    <p><strong>æ—¶é—´ï¼š</strong>${shot.timeRange}</p>
                    <p><strong>ç”»é¢ï¼š</strong>${shot.scene}</p>
                    <p><strong>åŠ¨ä½œï¼š</strong>${shot.action}</p>
                    <p><strong>è§†è§‰ï¼š</strong>${shot.visual}</p>
                    <p><strong>éŸ³æ•ˆï¼š</strong>${shot.audio}</p>
                    ${shot.transition ? `<p><strong>è½¬åœºï¼š</strong>${shot.transition}</p>` : ''}
                    <div class="shot-actions">
                        <button class="copy-shot-btn" onclick="copyScriptShot(${shot.number}, this)">
                            ğŸ“‹ å¤åˆ¶æ­¤åˆ†é•œ
                        </button>
                    </div>
                </div>
            `).join('');

            // æ˜¾ç¤ºå®Œæ•´è„šæœ¬
            const scriptOutputEnhanced = document.getElementById('scriptOutputEnhanced');
            scriptOutputEnhanced.textContent = script;

            // æ˜¾ç¤ºè¾“å‡ºåŒºåŸŸ
            document.getElementById('scriptOutput').style.display = 'block';
            document.getElementById('scriptExportButtons').style.display = 'flex';
        }

        // è§£æè„šæœ¬æ•°æ®
        function parseScriptData(script) {
            const lines = script.split('\n');
            const keyword = lines.find(line => line.includes('è§†é¢‘ä¸»é¢˜ï¼š'))?.split('ï¼š')[1]?.trim() || 'æœªçŸ¥ä¸»é¢˜';
            const shotCountText = lines.find(line => line.includes('åˆ†é•œæ•°é‡ï¼š'))?.split('ï¼š')[1]?.trim() || 'æœªçŸ¥';
            const shotCount = parseInt(shotCountText) || 0;

            const shots = [];
            let currentShot = null;
            let shotNumber = 1;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // åŒ¹é…åˆ†é•œæ ‡é¢˜è¡Œï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
                if (line.match(/^åˆ†é•œ\s*\d+\s*[ï¼š:]/) || line.match(/^åˆ†é•œ\s*\d+/)) {
                    if (currentShot) {
                        shots.push(currentShot);
                    }

                    const title = line.includes('ï¼š') ? line.split('ï¼š')[1]?.trim() :
                                line.includes(':') ? line.split(':')[1]?.trim() : '';
                    currentShot = {
                        number: shotNumber++,
                        title: title || `åˆ†é•œ ${shotNumber}`,
                        timeRange: '',
                        scene: '',
                        action: '',
                        visual: '',
                        audio: '',
                        transition: ''
                    };
                } else if (currentShot) {
                    if (line.startsWith('æ—¶é—´:') || line.startsWith('æ—¶é—´ï¼š')) {
                        currentShot.timeRange = line.split(/[ï¼š:]/)[1]?.trim() || '';
                    } else if (line.startsWith('ç”»é¢:') || line.startsWith('ç”»é¢ï¼š')) {
                        currentShot.scene = line.split(/[ï¼š:]/)[1]?.trim() || '';
                    } else if (line.startsWith('åŠ¨ä½œ:') || line.startsWith('åŠ¨ä½œï¼š')) {
                        currentShot.action = line.split(/[ï¼š:]/)[1]?.trim() || '';
                    } else if (line.startsWith('è§†è§‰:') || line.startsWith('è§†è§‰ï¼š')) {
                        currentShot.visual = line.split(/[ï¼š:]/)[1]?.trim() || '';
                    } else if (line.startsWith('éŸ³æ•ˆ:') || line.startsWith('éŸ³æ•ˆï¼š')) {
                        currentShot.audio = line.split(/[ï¼š:]/)[1]?.trim() || '';
                    } else if (line.startsWith('è½¬åœº:') || line.startsWith('è½¬åœºï¼š')) {
                        currentShot.transition = line.split(/[ï¼š:]/)[1]?.trim() || '';
                    }
                }
            }

            if (currentShot) {
                shots.push(currentShot);
            }

            // å¦‚æœè§£æå¤±è´¥æˆ–åˆ†é•œæ•°é‡ä¸è¶³ï¼Œåˆ›å»ºé»˜è®¤åˆ†é•œ
            if (shots.length < shotCount) {
                const avgDuration = Math.floor(15 / shotCount);
                for (let i = shots.length + 1; i <= shotCount; i++) {
                    const startTime = (i - 1) * avgDuration;
                    const endTime = i === shotCount ? 15 : i * avgDuration;
                    shots.push({
                        number: i,
                        title: `åˆ†é•œ ${i}`,
                        timeRange: `${startTime}ç§’ - ${endTime}ç§’`,
                        scene: `${keyword}ç›¸å…³çš„åˆ†é•œ${i}æè¿°`,
                        action: 'å±•ç¤ºå…³é”®åŠ¨ä½œå’Œæƒ…èŠ‚å‘å±•',
                        visual: 'ä¸“ä¸šçº§ç”»é¢æ„å›¾ï¼Œå…‰çº¿è¿ç”¨è‡ªç„¶',
                        audio: 'é…åˆç”»é¢çš„éŸ³æ•ˆè®¾è®¡',
                        transition: 'æµç•…è½¬åœº'
                    });
                }
            }

            // è®¡ç®—æ¯ä¸ªåˆ†é•œçš„æ—¶é•¿
            shots.forEach(shot => {
                if (shot.timeRange.includes('-')) {
                    const times = shot.timeRange.match(/(\d+)/g);
                    if (times && times.length >= 2) {
                        shot.duration = parseInt(times[1]) - parseInt(times[0]);
                    } else {
                        shot.duration = Math.floor(15 / shots.length);
                    }
                } else {
                    shot.duration = Math.floor(15 / shots.length);
                }

                // å¦‚æœæ²¡æœ‰åŠ¨ä½œæè¿°ï¼Œä½¿ç”¨åœºæ™¯æè¿°
                if (!shot.action) {
                    shot.action = shot.scene;
                }
            });

            return {
                keyword: keyword,
                shotCount: shotCount,
                totalDuration: 15,
                shots: shots
            };
        }

        // å¤åˆ¶è„šæœ¬
        function copyScript() {
            navigator.clipboard.writeText(currentScript).then(() => {
                showMessage('è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // ä¸‹è½½è„šæœ¬
        function downloadScript() {
            const blob = new Blob([currentScript], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AIè§†é¢‘è„šæœ¬_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showMessage('è„šæœ¬ä¸‹è½½æˆåŠŸ', 'success');
        }

        // å¤åˆ¶Soraæ ¼å¼
        function copyForSora() {
            // ç®€å•çš„Soraæ ¼å¼è½¬æ¢
            const soraFormat = currentScript.replace(/åˆ†é•œ \d+:/g, '--scene ');
            navigator.clipboard.writeText(soraFormat).then(() => {
                showMessage('Soraæ ¼å¼è„šæœ¬å·²å¤åˆ¶', 'success');
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // å¤åˆ¶ä¼ ç»Ÿåˆ†é•œ
        function copyScriptShots() {
            if (!currentScriptData) {
                showMessage('è¯·å…ˆç”Ÿæˆè„šæœ¬', 'error');
                return;
            }

            const shots = currentScriptData.shots.map(shot =>
                `åˆ†é•œ${shot.number}ï¼š${shot.title}
${shot.duration}ç§’ - ${shot.timeRange}ï¼Œ${shot.scene}ï¼Œ${shot.visual}ï¼Œ${shot.audio}`
            );

            navigator.clipboard.writeText(shots.join('\n\n')).then(() => {
                showMessage('ä¼ ç»Ÿåˆ†é•œè„šæœ¬å·²å¤åˆ¶', 'success');
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // å¤åˆ¶æŒ‡å®šçš„å•ä¸ªä¼ ç»Ÿåˆ†é•œ
        function copyScriptShot(shotNumber, buttonElement) {
            if (!currentScriptData) {
                showMessage('è¯·å…ˆç”Ÿæˆè„šæœ¬', 'error');
                return;
            }

            const shot = currentScriptData.shots.find(s => s.number === shotNumber);
            if (!shot) {
                showMessage('æ‰¾ä¸åˆ°æŒ‡å®šçš„åˆ†é•œ', 'error');
                return;
            }

            // æ„å»ºSora2æ ¼å¼çš„åˆ†é•œæç¤ºè¯
            const soraPrompt = `åˆ†é•œ ${shotNumber}ï¼š${shot.title}
æ—¶é•¿ï¼š${shot.duration}ç§’
æ—¶é—´ï¼š${shot.timeRange}
ç”»é¢ï¼š${shot.scene}
è§†è§‰ï¼š${shot.visual}
éŸ³æ•ˆï¼š${shot.audio}

Sora2æç¤ºè¯ï¼š${shot.scene}ï¼Œ${shot.visual}ï¼Œä¸“ä¸šè§†é¢‘åˆ¶ä½œï¼Œé«˜è´¨é‡æ¸²æŸ“ï¼Œ${shot.duration}ç§’è§†é¢‘`;

            navigator.clipboard.writeText(soraPrompt).then(() => {
                // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'âœ… å·²å¤åˆ¶';
                buttonElement.classList.add('copied');

                showMessage(`åˆ†é•œ ${shotNumber} å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, 'success');

                // 2ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);

            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // æ‰“å¼€åˆ†é•œå›¾ç”Ÿæˆå™¨
        function openStoryboardGenerator() {
            if (!currentScript) {
                showMessage('è¯·å…ˆç”Ÿæˆè„šæœ¬', 'error');
                return;
            }

            // å­˜å‚¨è„šæœ¬åˆ°localStorage
            localStorage.setItem('storyboardScript', currentScript);

            // æ‰“å¼€åˆ†é•œå·¥å…·
            window.open('storyboard-image-generator.html', '_blank');
        }

        // åŠ è½½ä¿å­˜çš„API Key
        function loadSavedApiKey() {
            const savedApiKey = localStorage.getItem('savedApiKey');
            const savedProvider = localStorage.getItem('savedProvider');

            if (savedProvider) {
                document.getElementById('apiProvider').value = savedProvider;
            }

            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
                validateApiKey();
            }

            updateApiSettings();
        }

        // ä¿å­˜API Key
        document.getElementById('apiKey').addEventListener('change', function() {
            const apiKey = this.value.trim();
            const provider = document.getElementById('apiProvider').value;

            if (apiKey) {
                localStorage.setItem('savedApiKey', apiKey);
                localStorage.setItem('savedProvider', provider);
            }
        });

        console.log('ğŸ‰ AIè§†é¢‘è„šæœ¬ç”Ÿæˆå·¥å…·ç»ˆæç‰ˆåŠ è½½å®Œæˆ');

        // ============ AIåŠ¨æ¼«æ•…äº‹åŠŸèƒ½ ============

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
            if (tabName === 'script') {
                document.querySelector('.tab-btn[onclick="switchTab(\'script\')"]').classList.add('active');
                document.getElementById('scriptTab').classList.add('active');
            } else if (tabName === 'anime') {
                document.querySelector('.tab-btn[onclick="switchTab(\'anime\')"]').classList.add('active');
                document.getElementById('animeTab').classList.add('active');
            } else if (tabName === 'ecommerce') {
                document.querySelector('.tab-btn[onclick="switchTab(\'ecommerce\')"]').classList.add('active');
                document.getElementById('ecommerceTab').classList.add('active');
            } else if (tabName === 'beauty') {
                document.querySelector('.tab-btn[onclick="switchTab(\'beauty\')"]').classList.add('active');
                document.getElementById('beautyTab').classList.add('active');
            }

            const tabNames = {
                'script': 'ä¼ ç»Ÿåˆ†é•œ',
                'anime': 'AIåŠ¨æ¼«',
                'ecommerce': 'æç¬‘ç”µå•†å¸¦è´§',
                'beauty': 'ç¾å¦†æ•™ç¨‹å¸¦è´§'
            };
            console.log(`ğŸ”„ åˆ‡æ¢åˆ°${tabNames[tabName]}æ ‡ç­¾`);
        }

        // ç”ŸæˆAIåŠ¨æ¼«æ•…äº‹
        async function generateAnimeStory() {
            const keyword = document.getElementById('animeKeyword').value.trim();
            const storyType = document.getElementById('storyType').value;
            const totalDuration = parseInt(document.getElementById('totalDuration').value);
            const shotDuration = parseInt(document.getElementById('shotDuration').value);

            if (!keyword) {
                showMessage('è¯·è¾“å…¥åŠ¨æ¼«æ•…äº‹ä¸»é¢˜', 'error');
                return;
            }

            const provider = document.getElementById('apiProvider').value;
            if (provider !== 'local' && !apiConfig.apiKey) {
                showMessage('è¯·å…ˆé…ç½®API Key', 'error');
                return;
            }

            // ç¦ç”¨ç”ŸæˆæŒ‰é’®
            const generateBtn = document.querySelector('button[onclick="generateAnimeStory()"]');
            generateBtn.disabled = true;
            generateBtn.textContent = 'ğŸŒ ç”Ÿæˆä¸­...';

            try {
                showMessage('æ­£åœ¨ç”ŸæˆAIåŠ¨æ¼«æ•…äº‹...', 'info');

                let storyData;
                if (provider === 'local') {
                    storyData = generateMockAnimeStory(keyword, storyType, totalDuration, shotDuration);
                } else {
                    storyData = await generateAIAnimeStory(keyword, storyType, totalDuration, shotDuration);
                }

                currentAnimeStory = storyData;
                displayAnimeStory(storyData);
                showMessage(`âœ… æˆåŠŸç”ŸæˆåŒ…å«${storyData.shots.length}ä¸ªåˆ†é•œçš„åŠ¨æ¼«æ•…äº‹ï¼`, 'success');

            } catch (error) {
                console.error('AIåŠ¨æ¼«æ•…äº‹ç”Ÿæˆå¤±è´¥:', error);
                showMessage(`âŒ ç”Ÿæˆå¤±è´¥ï¼š${error.message}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                generateBtn.disabled = false;
                generateBtn.textContent = 'ğŸŒ ç”ŸæˆåŠ¨æ¼«æ•…äº‹';
            }
        }

        // AIç”ŸæˆåŠ¨æ¼«æ•…äº‹
        async function generateAIAnimeStory(keyword, storyType, totalDuration, shotDuration) {
            const shotCount = Math.ceil(totalDuration / shotDuration);
            const prompt = buildAnimePrompt(keyword, storyType, totalDuration, shotDuration, shotCount);

            console.log('ğŸŒ å¼€å§‹AIç”ŸæˆåŠ¨æ¼«æ•…äº‹:', { keyword, storyType, totalDuration, shotDuration, shotCount });

            const response = await fetch(`${apiConfig.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiConfig.apiKey}`
                },
                body: JSON.stringify({
                    model: getChatModel(),
                    messages: [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŠ¨æ¼«å‰§æœ¬ä½œå®¶ï¼Œæ“…é•¿åˆ›ä½œå„ç§ç±»å‹çš„åŠ¨æ¼«æ•…äº‹ï¼Œç‰¹åˆ«æ“…é•¿å°†é•¿æ•…äº‹åˆ†å‰²æˆé€‚åˆçŸ­è§†é¢‘çš„ç‰‡æ®µã€‚'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 3000,
                    temperature: 0.8
                })
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(`AIç”Ÿæˆå¤±è´¥ (${response.status}): ${error.error?.message || response.statusText}`);
            }

            const data = await response.json();
            const aiContent = data.choices?.[0]?.message?.content || '';

            if (!aiContent) {
                throw new Error('AIè¿”å›å†…å®¹ä¸ºç©º');
            }

            console.log('âœ… AIåŠ¨æ¼«æ•…äº‹ç”ŸæˆæˆåŠŸ:', aiContent.length, 'å­—ç¬¦');

            return parseAnimeStory(aiContent, keyword, storyType, totalDuration, shotDuration);
        }

        // æ„å»ºåŠ¨æ¼«æ•…äº‹AIæç¤ºè¯
        function buildAnimePrompt(keyword, storyType, totalDuration, shotDuration, shotCount) {
            const typeMap = {
                'adventure': 'å†’é™©å¥‡å¹»',
                'romance': 'é’æ˜¥æ‹çˆ±',
                'scifi': 'ç§‘å¹»æœªæ¥',
                'mystery': 'æ‚¬ç–‘æ¨ç†',
                'comedy': 'è½»æ¾æ—¥å¸¸',
                'action': 'çƒ­è¡€æˆ˜æ–—',
                'fantasy': 'å¼‚ä¸–ç•Œç©¿è¶Š'
            };

            const storyTypeName = typeMap[storyType] || 'å†’é™©å¥‡å¹»';

            return `è¯·ä¸º"${keyword}"è¿™ä¸ªä¸»é¢˜åˆ›ä½œä¸€ä¸ª${storyTypeName}ç±»å‹çš„åŠ¨æ¼«æ•…äº‹å‰§æœ¬ã€‚

è¦æ±‚ï¼š
1. æ•…äº‹ä¸»é¢˜ï¼š${keyword}
2. æ•…äº‹ç±»å‹ï¼š${storyTypeName}
3. æ€»æ—¶é•¿ï¼š${totalDuration}ç§’ï¼ˆçº¦${Math.floor(totalDuration/60)}åˆ†${totalDuration%60}ç§’ï¼‰
4. åˆ†é•œæ•°é‡ï¼š${shotCount}ä¸ªåˆ†é•œï¼Œæ¯ä¸ªåˆ†é•œ${shotDuration}ç§’
5. ç›®æ ‡ï¼šä¸ºSora2è§†é¢‘ç”Ÿæˆä¼˜åŒ–ï¼Œæ¯ä¸ªåˆ†é•œéƒ½èƒ½ç‹¬ç«‹ç”Ÿæˆ10-15ç§’è§†é¢‘

æ•…äº‹ç»“æ„è¦æ±‚ï¼š
- å¼€å¤´ï¼ˆç¬¬1-2ä¸ªåˆ†é•œï¼‰ï¼šå¼•å…¥ä¸»è§’å’ŒèƒŒæ™¯
- å‘å±•ï¼ˆç¬¬3-${shotCount-2}ä¸ªåˆ†é•œï¼‰ï¼šæƒ…èŠ‚æ¨è¿›å’Œå†²çª
- é«˜æ½®ï¼ˆç¬¬${shotCount-1}ä¸ªåˆ†é•œï¼‰ï¼šæ•…äº‹é«˜æ½®
- ç»“å°¾ï¼ˆç¬¬${shotCount}ä¸ªåˆ†é•œï¼‰ï¼šæ•…äº‹æ”¶å°¾

è¯·æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
{
  "title": "${keyword}",
  "overview": "æ•…äº‹æ¦‚è§ˆï¼Œ50å­—ä»¥å†…",
  "shots": [
    {
      "number": 1,
      "title": "åˆ†é•œæ ‡é¢˜",
      "duration": ${shotDuration},
      "scene": "åœºæ™¯æè¿°",
      "action": "åŠ¨ä½œæè¿°",
      "dialogue": "å¯¹è¯å†…å®¹",
      "visual": "è§†è§‰ç‰¹æ•ˆæè¿°",
      "audio": "éŸ³æ•ˆé…ä¹å»ºè®®"
    }
  ]
}

è¯·ç¡®ä¿å†…å®¹åŸåˆ›ã€æœ‰åˆ›æ„ï¼Œç¬¦åˆ${storyTypeName}ç±»å‹çš„ç‰¹ç‚¹ï¼Œæ¯ä¸ªåˆ†é•œéƒ½èƒ½ç‹¬ç«‹æˆä¸ºä¸€ä¸ªå®Œæ•´çš„çŸ­è§†é¢‘ç‰‡æ®µã€‚`;
        }

        // è§£æAIç”Ÿæˆçš„åŠ¨æ¼«æ•…äº‹
        function parseAnimeStory(aiContent, keyword, storyType, totalDuration, shotDuration) {
            try {
                // å°è¯•è§£æJSONæ ¼å¼
                let storyData;
                if (aiContent.includes('{') && aiContent.includes('}')) {
                    const jsonMatch = aiContent.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        storyData = JSON.parse(jsonMatch[0]);
                    }
                }

                // å¦‚æœJSONè§£æå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ
                if (!storyData || !storyData.shots) {
                    storyData = generateMockAnimeStory(keyword, storyType, totalDuration, shotDuration);
                }

                return storyData;
            } catch (error) {
                console.warn('JSONè§£æå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ:', error);
                return generateMockAnimeStory(keyword, storyType, totalDuration, shotDuration);
            }
        }

        // ç”Ÿæˆæ¨¡æ‹ŸåŠ¨æ¼«æ•…äº‹
        function generateMockAnimeStory(keyword, storyType, totalDuration, shotDuration) {
            const shotCount = Math.ceil(totalDuration / shotDuration);

            const typeTemplates = {
                'adventure': {
                    overview: 'å‹‡æ•¢çš„å†’é™©è€…è¸ä¸Šå¯»æ‰¾ä¼ è¯´ä¸­çš„å®è—çš„å¾ç¨‹',
                    scenes: ['ç¥ç§˜æ£®æ—å…¥å£', 'å¤è€é—è¿¹æ¢ç´¢', 'é­é‡é­”æ³•ç”Ÿç‰©', 'å‘ç°å®è—çº¿ç´¢', 'æœ€ç»ˆå®è—è·å¾—']
                },
                'romance': {
                    overview: 'é’æ˜¥æ ¡å›­é‡Œçš„ç”œèœœæ‹çˆ±æ•…äº‹',
                    scenes: ['åˆé‡çš„ç¬é—´', 'æ ¡å›­æ—¥å¸¸ç›¸å¤„', 'å¿ƒåŠ¨æ—¶åˆ»', 'å°å°è¯¯ä¼š', 'å‘Šç™½ä¸å›åº”']
                },
                'scifi': {
                    overview: 'æœªæ¥ä¸–ç•Œçš„ç§‘æŠ€å†’é™©',
                    scenes: ['æœªæ¥åŸå¸‚', 'AIè§‰é†’', 'è™šæ‹Ÿç°å®', 'æ—¶é—´æ—…è¡Œ', 'æ–°ä¸–ç•Œæ¢ç´¢']
                },
                'mystery': {
                    overview: 'æ‰‘æœ”è¿·ç¦»çš„æ¨ç†æ¡ˆä»¶',
                    scenes: ['æ¡ˆä»¶å‘ç”Ÿ', 'çº¿ç´¢æ”¶é›†', 'æ¨ç†åˆ†æ', 'çœŸç›¸æ­éœ²', 'æ¡ˆä»¶è§£å†³']
                },
                'comedy': {
                    overview: 'è½»æ¾æç¬‘çš„æ—¥å¸¸æ•…äº‹',
                    scenes: ['æç¬‘æ—¥å¸¸', 'æ„å¤–äº‹ä»¶', 'ä¹Œé¾™ä¸æ–­', 'è¯¯ä¼šè§£é™¤', 'æ¸©é¦¨ç»“å±€']
                },
                'action': {
                    overview: 'çƒ­è¡€æ²¸è…¾çš„æˆ˜æ–—æ•…äº‹',
                    scenes: ['æˆ˜æ–—å‡†å¤‡', 'æ¿€çƒˆå¯¹æŠ—', 'æŠ€èƒ½å‡çº§', 'æœ€ç»ˆå†³æˆ˜', 'èƒœåˆ©æ—¶åˆ»']
                },
                'fantasy': {
                    overview: 'å¼‚ä¸–ç•Œçš„å¥‡å¹»å†’é™©',
                    scenes: ['ç©¿è¶Šå¼‚ä¸–ç•Œ', 'è·å¾—æ–°èƒ½åŠ›', 'æ¢ç´¢æ–°ä¸–ç•Œ', 'æˆ˜èƒœæ•Œäºº', 'æˆä¸ºè‹±é›„']
                }
            };

            const template = typeTemplates[storyType] || typeTemplates['adventure'];
            const scenes = template.scenes.slice(0, shotCount);

            const shots = scenes.map((scene, index) => ({
                number: index + 1,
                title: `${scene}`,
                duration: shotDuration,
                scene: `${keyword} - ${scene}`,
                action: `å…³äº${keyword}çš„${scene}çš„è¯¦ç»†åŠ¨ä½œæè¿°`,
                dialogue: `è§’è‰²åœ¨${scene}æ—¶çš„å¯¹è¯`,
                visual: `${scene}çš„ç²¾ç¾è§†è§‰ç‰¹æ•ˆ`,
                audio: `é…åˆ${scene}çš„éŸ³æ•ˆå’Œé…ä¹`
            }));

            return {
                title: keyword,
                overview: template.overview,
                type: storyType,
                totalDuration: totalDuration,
                shotDuration: shotDuration,
                shots: shots
            };
        }

        // æ˜¾ç¤ºåŠ¨æ¼«æ•…äº‹
        function displayAnimeStory(storyData) {
            // æ˜¾ç¤ºæ•…äº‹æ¦‚è§ˆ
            const storyOverview = document.getElementById('storyOverview');
            storyOverview.innerHTML = `
                <p><strong>ğŸ“– æ•…äº‹æ ‡é¢˜ï¼š</strong>${storyData.title}</p>
                <p><strong>ğŸ­ æ•…äº‹ç±»å‹ï¼š</strong>${storyData.type || 'åŠ¨æ¼«'}</p>
                <p><strong>â±ï¸ æ€»æ—¶é•¿ï¼š</strong>${storyData.totalDuration}ç§’</p>
                <p><strong>ğŸ¬ åˆ†é•œæ•°é‡ï¼š</strong>${storyData.shots.length}ä¸ª</p>
                <p><strong>ğŸ“ æ•…äº‹æ¦‚è§ˆï¼š</strong>${storyData.overview}</p>
            `;

            // æ˜¾ç¤ºåˆ†é•œé¢„è§ˆ
            const shotPreview = document.getElementById('shotPreview');
            shotPreview.innerHTML = storyData.shots.map(shot => `
                <div class="shot-preview">
                    <div class="shot-header">
                        <span class="shot-number">åˆ†é•œ ${shot.number}</span>
                        <span class="shot-duration">${shot.duration}ç§’</span>
                    </div>
                    <h4>${shot.title}</h4>
                    <p><strong>åœºæ™¯ï¼š</strong>${shot.scene}</p>
                    <p><strong>åŠ¨ä½œï¼š</strong>${shot.action}</p>
                    <p><strong>å¯¹è¯ï¼š</strong>${shot.dialogue}</p>
                    <p><strong>è§†è§‰ï¼š</strong>${shot.visual}</p>
                    <p><strong>éŸ³æ•ˆï¼š</strong>${shot.audio}</p>
                    <div class="shot-actions">
                        <button class="copy-shot-btn" onclick="copyIndividualShot(${shot.number}, this)">
                            ğŸ“‹ å¤åˆ¶æ­¤åˆ†é•œ
                        </button>
                    </div>
                </div>
            `).join('');

            // æ˜¾ç¤ºå®Œæ•´è„šæœ¬
            const animeScriptOutput = document.getElementById('animeScriptOutput');
            let fullScript = `åŠ¨æ¼«æ•…äº‹è„šæœ¬ - ${storyData.title}
====================================

æ•…äº‹æ¦‚è§ˆï¼š
${storyData.overview}

æ€»æ—¶é•¿ï¼š${storyData.totalDuration}ç§’
åˆ†é•œæ•°é‡ï¼š${storyData.shots.length}ä¸ª
ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}

====================================

`;

            storyData.shots.forEach(shot => {
                fullScript += `åˆ†é•œ ${shot.number}ï¼š${shot.title} (${shot.duration}ç§’)
----------------------------------------
åœºæ™¯ï¼š${shot.scene}
åŠ¨ä½œï¼š${shot.action}
å¯¹è¯ï¼š${shot.dialogue}
è§†è§‰ç‰¹æ•ˆï¼š${shot.visual}
éŸ³æ•ˆé…ä¹ï¼š${shot.audio}

`;
            });

            animeScriptOutput.textContent = fullScript;

            // æ˜¾ç¤ºè¾“å‡ºåŒºåŸŸ
            document.getElementById('storyOutput').style.display = 'block';
            document.getElementById('animeExportButtons').style.display = 'flex';
        }

        // å¤åˆ¶åŠ¨æ¼«è„šæœ¬
        function copyAnimeScript() {
            const scriptText = document.getElementById('animeScriptOutput').textContent;
            navigator.clipboard.writeText(scriptText).then(() => {
                showMessage('åŠ¨æ¼«è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // ä¸‹è½½åŠ¨æ¼«è„šæœ¬
        function downloadAnimeScript() {
            const scriptText = document.getElementById('animeScriptOutput').textContent;
            const blob = new Blob([scriptText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AIåŠ¨æ¼«æ•…äº‹è„šæœ¬_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showMessage('åŠ¨æ¼«è„šæœ¬ä¸‹è½½æˆåŠŸ', 'success');
        }

        // æ‰¹é‡å¯¼å‡ºSora2æ ¼å¼
        function exportSora2Batch() {
            if (!currentAnimeStory) {
                showMessage('è¯·å…ˆç”ŸæˆåŠ¨æ¼«æ•…äº‹', 'error');
                return;
            }

            let batchScript = `Sora2æ‰¹é‡å¯¼å‡º - ${currentAnimeStory.title}
====================================
æ€»è®¡${currentAnimeStory.shots.length}ä¸ªåˆ†é•œï¼Œæ¯ä¸ªåˆ†é•œ${currentAnimeStory.shotDuration}ç§’

`;

            currentAnimeStory.shots.forEach((shot, index) => {
                batchScript += `ã€åˆ†é•œ ${shot.number}/${currentAnimeStory.shots.length}ã€‘${shot.title}
æ—¶é—´ï¼š${shot.duration}ç§’
Sora2æç¤ºè¯ï¼š${shot.scene}ï¼Œ${shot.action}ï¼Œ${shot.visual}ï¼ŒåŠ¨æ¼«é£æ ¼ï¼Œé«˜è´¨é‡æ¸²æŸ“

`;
            });

            navigator.clipboard.writeText(batchScript).then(() => {
                showMessage(`å·²å¤åˆ¶${currentAnimeStory.shots.length}ä¸ªåˆ†é•œçš„Sora2æ‰¹é‡è„šæœ¬`, 'success');
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // å¤åˆ¶å•ä¸ªåˆ†é•œ
        function copySingleShots() {
            if (!currentAnimeStory) {
                showMessage('è¯·å…ˆç”ŸæˆåŠ¨æ¼«æ•…äº‹', 'error');
                return;
            }

            const singleShots = currentAnimeStory.shots.map(shot =>
                `åˆ†é•œ${shot.number}ï¼š${shot.title}
${shot.duration}ç§’ - ${shot.scene}ï¼Œ${shot.action}ï¼Œ${shot.visual}`
            );

            navigator.clipboard.writeText(singleShots.join('\n\n')).then(() => {
                showMessage('å•ä¸ªåˆ†é•œè„šæœ¬å·²å¤åˆ¶', 'success');
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // å¤åˆ¶æŒ‡å®šçš„å•ä¸ªåˆ†é•œï¼ˆæ–°å¢åŠŸèƒ½ï¼‰
        function copyIndividualShot(shotNumber, buttonElement) {
            if (!currentAnimeStory) {
                showMessage('è¯·å…ˆç”ŸæˆåŠ¨æ¼«æ•…äº‹', 'error');
                return;
            }

            const shot = currentAnimeStory.shots.find(s => s.number === shotNumber);
            if (!shot) {
                showMessage('æ‰¾ä¸åˆ°æŒ‡å®šçš„åˆ†é•œ', 'error');
                return;
            }

            // æ„å»ºSora2æ ¼å¼çš„åˆ†é•œæç¤ºè¯
            const soraPrompt = `åˆ†é•œ ${shotNumber}ï¼š${shot.title}
æ—¶é•¿ï¼š${shot.duration}ç§’
åœºæ™¯ï¼š${shot.scene}
åŠ¨ä½œï¼š${shot.action}
å¯¹è¯ï¼š${shot.dialogue}
è§†è§‰ç‰¹æ•ˆï¼š${shot.visual}
éŸ³æ•ˆé…ä¹ï¼š${shot.audio}

Sora2æç¤ºè¯ï¼š${shot.scene}ï¼Œ${shot.action}ï¼Œ${shot.visual}ï¼ŒåŠ¨æ¼«é£æ ¼ï¼Œé«˜è´¨é‡æ¸²æŸ“ï¼Œ${shot.duration}ç§’è§†é¢‘`;

            navigator.clipboard.writeText(soraPrompt).then(() => {
                // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'âœ… å·²å¤åˆ¶';
                buttonElement.classList.add('copied');

                showMessage(`åˆ†é•œ ${shotNumber} å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, 'success');

                // 2ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);

            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // ============ æç¬‘ç”µå•†å¸¦è´§åŠŸèƒ½ ============

        // ç”Ÿæˆæç¬‘ç”µå•†å¸¦è´§æ–‡æ¡ˆ
        async function generateEcommerceScript() {
            const keyword = document.getElementById('ecommerceKeyword').value.trim();
            const productInfo = document.getElementById('productInfo').value.trim();
            const comedyStyle = document.getElementById('comedyStyle').value;
            const duration = parseInt(document.getElementById('ecommerceDuration').value);
            const platform = document.getElementById('targetPlatform').value;

            if (!keyword || !productInfo) {
                showMessage('è¯·è¾“å…¥è§†é¢‘ä¸»é¢˜å’Œå¸¦è´§å•†å“', 'error');
                return;
            }

            const provider = document.getElementById('apiProvider').value;
            if (provider !== 'local' && !apiConfig.apiKey) {
                showMessage('è¯·å…ˆé…ç½®API Key', 'error');
                return;
            }

            // ç¦ç”¨ç”ŸæˆæŒ‰é’®
            const generateBtn = document.querySelector('button[onclick="generateEcommerceScript()"]');
            generateBtn.disabled = true;
            generateBtn.textContent = 'ğŸ›’ ç”Ÿæˆä¸­...';

            try {
                showMessage('æ­£åœ¨ç”Ÿæˆæç¬‘å¸¦è´§æ–‡æ¡ˆ...', 'info');

                let scriptData;
                if (provider === 'local') {
                    scriptData = generateMockEcommerceScript(keyword, productInfo, comedyStyle, duration, platform);
                } else {
                    scriptData = await generateAIEcommerceScript(keyword, productInfo, comedyStyle, duration, platform);
                }

                currentEcommerceScript = scriptData;
                displayEcommerceScript(scriptData);
                showMessage(`âœ… æˆåŠŸç”Ÿæˆæç¬‘å¸¦è´§æ–‡æ¡ˆï¼Œ${duration}ç§’å®Œç¾é€‚é…Sora2ï¼`, 'success');

            } catch (error) {
                console.error('æç¬‘å¸¦è´§æ–‡æ¡ˆç”Ÿæˆå¤±è´¥:', error);
                showMessage(`âŒ ç”Ÿæˆå¤±è´¥ï¼š${error.message}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                generateBtn.disabled = false;
                generateBtn.textContent = 'ğŸ›’ ç”Ÿæˆæç¬‘å¸¦è´§æ–‡æ¡ˆ';
            }
        }

        // AIç”Ÿæˆæç¬‘ç”µå•†å¸¦è´§æ–‡æ¡ˆ
        async function generateAIEcommerceScript(keyword, productInfo, comedyStyle, duration, platform) {
            const prompt = buildEcommercePrompt(keyword, productInfo, comedyStyle, duration, platform);

            console.log('ğŸ›’ å¼€å§‹AIç”Ÿæˆæç¬‘å¸¦è´§æ–‡æ¡ˆ:', { keyword, productInfo, comedyStyle, duration, platform });

            const response = await fetch(`${apiConfig.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiConfig.apiKey}`
                },
                body: JSON.stringify({
                    model: getChatModel(),
                    messages: [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æç¬‘å¸¦è´§æ–‡æ¡ˆå†™æ‰‹ï¼Œæ“…é•¿åˆ›ä½œå¹½é»˜é£è¶£çš„ç”µå•†çŸ­è§†é¢‘æ–‡æ¡ˆï¼Œè®©ç”¨æˆ·åœ¨æ¬¢ç¬‘ä¸­äº§ç”Ÿè´­ä¹°æ¬²æœ›ã€‚'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 2000,
                    temperature: 0.9
                })
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(`AIç”Ÿæˆå¤±è´¥ (${response.status}): ${error.error?.message || response.statusText}`);
            }

            const data = await response.json();
            const aiContent = data.choices?.[0]?.message?.content || '';

            if (!aiContent) {
                throw new Error('AIè¿”å›å†…å®¹ä¸ºç©º');
            }

            console.log('âœ… AIæç¬‘å¸¦è´§æ–‡æ¡ˆç”ŸæˆæˆåŠŸ:', aiContent.length, 'å­—ç¬¦');

            return parseEcommerceScript(aiContent, keyword, productInfo, comedyStyle, duration, platform);
        }

        // æ„å»ºç”µå•†å¸¦è´§AIæç¤ºè¯
        function buildEcommercePrompt(keyword, productInfo, comedyStyle, duration, platform) {
            const styleMap = {
                'sarcasm': 'åè®½å¼æç¬‘',
                'exaggeration': 'å¤¸å¼ å¼æç¬‘',
                'misunderstanding': 'è¯¯ä¼šå¼æç¬‘',
                'comparison': 'å¯¹æ¯”å¼æç¬‘',
                'selfdeprecation': 'è‡ªå˜²å¼æç¬‘',
                'unexpected': 'åè½¬å¼æç¬‘'
            };

            const platformMap = {
                'douyin': 'æŠ–éŸ³',
                'kuaishou': 'å¿«æ‰‹',
                'xiaohongshu': 'å°çº¢ä¹¦',
                'bilibili': 'Bç«™'
            };

            const styleName = styleMap[comedyStyle] || 'åè®½å¼æç¬‘';
            const platformName = platformMap[platform] || 'æŠ–éŸ³';

            return `è¯·ä¸º"${keyword}"è¿™ä¸ªä¸»é¢˜åˆ›ä½œä¸€ä¸ª${styleName}çš„ç”µå•†å¸¦è´§çŸ­è§†é¢‘æ–‡æ¡ˆã€‚

è¦æ±‚ï¼š
1. è§†é¢‘ä¸»é¢˜ï¼š${keyword}
2. å¸¦è´§å•†å“ï¼š${productInfo}
3. æç¬‘é£æ ¼ï¼š${styleName}
4. è§†é¢‘æ—¶é•¿ï¼š${duration}ç§’
5. ç›®æ ‡å¹³å°ï¼š${platformName}
6. æ ¸å¿ƒç›®æ ‡ï¼šè®©ç”¨æˆ·åœ¨æ¬¢ç¬‘ä¸­è®°ä½å•†å“å¹¶äº§ç”Ÿè´­ä¹°æ¬²

æç¬‘è¦æ±‚ï¼š
- å•†å“æ¤å…¥è¦è‡ªç„¶ï¼Œä¸èƒ½ç”Ÿç¡¬
- ç¬‘ç‚¹è¦æ–°é¢–æœ‰è¶£ï¼Œé¿å…ä½ä¿—
- æ•…äº‹è¦æœ‰åè½¬æˆ–æ„å¤–
- äº§å“ä¼˜ç‚¹è¦é€šè¿‡æç¬‘æ–¹å¼ä½“ç°

è¯·æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
{
  "title": "å¸å¼•çœ¼çƒçš„æ ‡é¢˜",
  "hook": "å‰3ç§’çš„é’©å­æ–‡æ¡ˆ",
  "story": "æç¬‘æ•…äº‹æƒ…èŠ‚",
  "product_integration": "å•†å“èå…¥æ–¹å¼",
  "call_to_action": "è¡ŒåŠ¨å·å¬è¯­",
  "shots": [
    {
      "number": 1,
      "duration": ${duration/3},
      "scene": "åœºæ™¯æè¿°",
      "action": "åŠ¨ä½œå’Œè¡¨æƒ…",
      "dialogue": "å¯¹è¯æˆ–æ—ç™½",
      "product_show": "å•†å“å±•ç¤ºæ–¹å¼",
      "visual": "è§†è§‰æ•ˆæœ"
    }
  ]
}

è¯·ç¡®ä¿å†…å®¹åŸåˆ›ã€æç¬‘ã€æœ‰åˆ›æ„ï¼Œå•†å“æ¤å…¥è‡ªç„¶ä¸è¿å’Œï¼Œé€‚åˆ${platformName}å¹³å°çš„ç”¨æˆ·å–œå¥½ã€‚`;
        }

        // è§£æAIç”Ÿæˆçš„ç”µå•†æ–‡æ¡ˆ
        function parseEcommerceScript(aiContent, keyword, productInfo, comedyStyle, duration, platform) {
            try {
                // å°è¯•è§£æJSONæ ¼å¼
                let scriptData;
                if (aiContent.includes('{') && aiContent.includes('}')) {
                    const jsonMatch = aiContent.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        scriptData = JSON.parse(jsonMatch[0]);
                    }
                }

                // å¦‚æœJSONè§£æå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ
                if (!scriptData || !scriptData.shots) {
                    scriptData = generateMockEcommerceScript(keyword, productInfo, comedyStyle, duration, platform);
                }

                return scriptData;
            } catch (error) {
                console.warn('JSONè§£æå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ:', error);
                return generateMockEcommerceScript(keyword, productInfo, comedyStyle, duration, platform);
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿç”µå•†å¸¦è´§æ–‡æ¡ˆ
        function generateMockEcommerceScript(keyword, productInfo, comedyStyle, duration, platform) {
            const shotCount = 3; // ç”µå•†å¸¦è´§ä¸€èˆ¬3ä¸ªåˆ†é•œ
            const avgDuration = Math.floor(duration / shotCount);

            const styleTemplates = {
                'sarcasm': {
                    hook: `æˆ‘ä»¥ä¸º${keyword}å¾ˆç®€å•ï¼Œç›´åˆ°æˆ‘å‘ç°äº†è¿™ä¸ª${productInfo}...`,
                    story: 'ç”¨åè®½çš„è¯­æ°”å±•ç¤ºä½¿ç”¨äº§å“å‰åçš„å·¨å¤§åå·®',
                    cta: 'åˆ«åƒæˆ‘ä¸€æ ·èµ°å¼¯è·¯ï¼Œç›´æ¥ç‚¹å‡»è´­ä¹°ï¼'
                },
                'exaggeration': {
                    hook: `${keyword}é‡åˆ°è¿™ä¸ª${productInfo}åï¼Œæˆ‘çš„ç”Ÿæ´»å‘ç”Ÿäº†ç¿»å¤©è¦†åœ°çš„å˜åŒ–ï¼`,
                    story: 'ç”¨æåº¦å¤¸å¼ çš„æ–¹å¼å±•ç¤ºäº§å“çš„ç¥å¥‡æ•ˆæœ',
                    cta: 'æƒ³è¦åŒæ¬¾ç¥å¥‡ä½“éªŒï¼Ÿé©¬ä¸Šå…¥æ‰‹ï¼'
                },
                'misunderstanding': {
                    hook: `æˆ‘ä»¥ä¸º${productInfo}åªæ˜¯æ™®é€šå•†å“ï¼Œç»“æœå®Œå…¨ä¼šé”™æ„äº†...`,
                    story: 'é€šè¿‡è¯¯ä¼šåˆ¶é€ ç¬‘ç‚¹ï¼Œæ„å¤–å‘ç°äº§å“ä¼˜ç‚¹',
                    cta: 'åˆ«å†è¯¯ä¼šäº†ï¼Œè¿™ä¸ªå®è´çœŸçš„å¾ˆæ£’ï¼'
                },
                'comparison': {
                    hook: `æ²¡æœ‰${productInfo}çš„${keyword} VS æœ‰${productInfo}çš„${keyword}`,
                    story: 'å¯¹æ¯”å±•ç¤ºä½¿ç”¨äº§å“å‰åçš„æç¬‘å·®å¼‚',
                    cta: 'é€‰æ‹©æ­£ç¡®çš„é‚£ä¸€è¾¹ï¼Œç«‹å³è´­ä¹°ï¼'
                },
                'selfdeprecation': {
                    hook: `æˆ‘ä»¥å‰åœ¨${keyword}æ–¹é¢çœŸçš„å¾ˆèœï¼Œç›´åˆ°é‡åˆ°äº†å®ƒ...`,
                    story: 'è‡ªå˜²å¼å±•ç¤ºï¼Œçªå‡ºäº§å“å¦‚ä½•è§£å†³é—®é¢˜',
                    cta: 'åˆ«åšå°ç¬¨è›‹ï¼Œèªæ˜é€‰æ‹©è¿™ä¸ªï¼'
                },
                'unexpected': {
                    hook: `${keyword}ä¸­å®Œå…¨æ„æƒ³ä¸åˆ°çš„åè½¬ï¼Œç«Ÿç„¶æ˜¯å› ä¸º${productInfo}ï¼Ÿ`,
                    story: 'åˆ¶é€ æ„å¤–åè½¬ï¼Œå•†å“æˆä¸ºå…³é”®è½¬æŠ˜ç‚¹',
                    cta: 'æ„æƒ³ä¸åˆ°çš„å¥½ç‰©ï¼Œèµ¶ç´§ä¸‹å•ï¼'
                }
            };

            const template = styleTemplates[comedyStyle] || styleTemplates['sarcasm'];

            const shots = [
                {
                    number: 1,
                    duration: avgDuration,
                    scene: `${keyword}åœºæ™¯ - é—®é¢˜å‡ºç°`,
                    action: 'å¤¸å¼ çš„è¡¨æƒ…å’ŒåŠ¨ä½œ',
                    dialogue: template.hook,
                    product_show: 'å•†å“åˆéœ²é¢',
                    visual: 'æç¬‘çš„è§†è§‰å¯¹æ¯”'
                },
                {
                    number: 2,
                    duration: avgDuration,
                    scene: 'ä½¿ç”¨äº§å“çš„è¿‡ç¨‹',
                    action: 'æ„æƒ³ä¸åˆ°çš„ä½¿ç”¨æ–¹å¼',
                    dialogue: template.story,
                    product_show: 'äº§å“åŠŸèƒ½å±•ç¤º',
                    visual: 'å¤¸å¼ çš„äº§å“æ•ˆæœ'
                },
                {
                    number: 3,
                    duration: duration - avgDuration * 2,
                    scene: 'æ•ˆæœå±•ç¤ºå’Œæ€»ç»“',
                    action: 'æ»¡æ„æˆ–æƒŠè®¶çš„è¡¨æƒ…',
                    dialogue: template.cta,
                    product_show: 'å•†å“ç‰¹å†™',
                    visual: 'è´­ä¹°é“¾æ¥æˆ–äºŒç»´ç '
                }
            ];

            return {
                title: `${keyword}ç¥æ“ä½œï¼è¿™ä¸ª${productInfo}å¤ªç»äº†ï¼`,
                hook: template.hook,
                story: template.story,
                product_integration: `è‡ªç„¶èå…¥${productInfo}åˆ°${keyword}åœºæ™¯ä¸­`,
                call_to_action: template.cta,
                keyword: keyword,
                product: productInfo,
                style: comedyStyle,
                duration: duration,
                platform: platform,
                shots: shots
            };
        }

        // æ˜¾ç¤ºç”µå•†å¸¦è´§æ–‡æ¡ˆ
        function displayEcommerceScript(scriptData) {
            // æ˜¾ç¤ºæ–‡æ¡ˆæ¦‚è§ˆ
            const ecommerceOverview = document.getElementById('ecommerceOverview');
            ecommerceOverview.innerHTML = `
                <p><strong>ğŸ›’ å¸¦è´§å•†å“ï¼š</strong><span class="product-highlight">${scriptData.product}</span></p>
                <p><strong>ğŸ¬ è§†é¢‘ä¸»é¢˜ï¼š</strong>${scriptData.keyword}</p>
                <p><strong>ğŸ˜„ æç¬‘é£æ ¼ï¼š</strong>${scriptData.style}</p>
                <p><strong>â±ï¸ è§†é¢‘æ—¶é•¿ï¼š</strong>${scriptData.duration}ç§’</p>
                <p><strong>ğŸ“± ç›®æ ‡å¹³å°ï¼š</strong>${scriptData.platform}</p>
                <p><strong>ğŸ¯ æ ‡é¢˜ï¼š</strong>${scriptData.title}</p>
                <p><strong>ğŸª é’©å­æ–‡æ¡ˆï¼š</strong>${scriptData.hook}</p>
            `;

            // æ˜¾ç¤ºåˆ†é•œé¢„è§ˆ
            const ecommerceShotPreview = document.getElementById('ecommerceShotPreview');
            ecommerceShotPreview.innerHTML = scriptData.shots.map(shot => `
                <div class="ecommerce-shot">
                    <div class="product-tag">ğŸ›’ ${shot.product_show}</div>
                    <div class="shot-header">
                        <span class="shot-number">åˆ†é•œ ${shot.number}</span>
                        <span class="shot-duration">${shot.duration}ç§’</span>
                    </div>
                    <h4>${shot.scene}</h4>
                    <p><strong>åŠ¨ä½œï¼š</strong>${shot.action}</p>
                    <p><strong>å¯¹è¯ï¼š</strong>${shot.dialogue}</p>
                    <p><strong>å•†å“å±•ç¤ºï¼š</strong>${shot.product_show}</p>
                    <p><strong>è§†è§‰æ•ˆæœï¼š</strong>${shot.visual}</p>
                    <div class="shot-actions">
                        <button class="copy-shot-btn" onclick="copyEcommerceShot(${shot.number}, this)">
                            ğŸ“‹ å¤åˆ¶æ­¤åˆ†é•œ
                        </button>
                    </div>
                </div>
            `).join('');

            // æ˜¾ç¤ºå®Œæ•´æ–‡æ¡ˆ
            const ecommerceScriptOutput = document.getElementById('ecommerceScriptOutput');
            let fullScript = `æç¬‘ç”µå•†å¸¦è´§æ–‡æ¡ˆ - ${scriptData.title}
====================================

å¸¦è´§å•†å“ï¼š${scriptData.product}
è§†é¢‘ä¸»é¢˜ï¼š${scriptData.keyword}
æç¬‘é£æ ¼ï¼š${scriptData.style}
ç›®æ ‡å¹³å°ï¼š${scriptData.platform}
æ€»æ—¶é•¿ï¼š${scriptData.duration}ç§’
ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}

====================================

ğŸ“± æ–‡æ¡ˆæ ‡é¢˜ï¼š${scriptData.title}
ğŸª å¼€å¤´é’©å­ï¼š${scriptData.hook}
ğŸ“– æ•…äº‹æƒ…èŠ‚ï¼š${scriptData.story}
ğŸ›’ å•†å“èå…¥ï¼š${scriptData.product_integration}
ğŸ“£ è¡ŒåŠ¨å·å¬ï¼š${scriptData.call_to_action}

====================================

åˆ†é•œè¯¦æƒ…ï¼š
`;

            scriptData.shots.forEach(shot => {
                fullScript += `
åˆ†é•œ ${shot.number}ï¼š${shot.scene} (${shot.duration}ç§’)
----------------------------------------
åŠ¨ä½œè¡¨æƒ…ï¼š${shot.action}
å¯¹è¯æ—ç™½ï¼š${shot.dialogue}
å•†å“å±•ç¤ºï¼š${shot.product_show}
è§†è§‰æ•ˆæœï¼š${shot.visual}

`;
            });

            ecommerceScriptOutput.textContent = fullScript;

            // æ˜¾ç¤ºè¾“å‡ºåŒºåŸŸ
            document.getElementById('ecommerceOutput').style.display = 'block';
            document.getElementById('ecommerceExportButtons').style.display = 'flex';
        }

        // å¤åˆ¶ç”µå•†æ–‡æ¡ˆ
        function copyEcommerceScript() {
            const scriptText = document.getElementById('ecommerceScriptOutput').textContent;
            navigator.clipboard.writeText(scriptText).then(() => {
                showMessage('å¸¦è´§æ–‡æ¡ˆå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // ä¸‹è½½ç”µå•†æ–‡æ¡ˆ
        function downloadEcommerceScript() {
            const scriptText = document.getElementById('ecommerceScriptOutput').textContent;
            const blob = new Blob([scriptText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æç¬‘ç”µå•†å¸¦è´§æ–‡æ¡ˆ_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showMessage('å¸¦è´§æ–‡æ¡ˆä¸‹è½½æˆåŠŸ', 'success');
        }

        // å¯¼å‡ºSora2æ ¼å¼
        function exportEcommerceSora() {
            if (!currentEcommerceScript) {
                showMessage('è¯·å…ˆç”Ÿæˆå¸¦è´§æ–‡æ¡ˆ', 'error');
                return;
            }

            let soraScript = `Sora2æç¬‘å¸¦è´§æ–‡æ¡ˆ - ${currentEcommerceScript.title}
====================================
å•†å“ï¼š${currentEcommerceScript.product}
æ—¶é•¿ï¼š${currentEcommerceScript.duration}ç§’

`;

            currentEcommerceScript.shots.forEach((shot, index) => {
                soraScript += `ã€åˆ†é•œ ${shot.number}/${currentEcommerceScript.shots.length}ã€‘${shot.scene}
æ—¶é—´ï¼š${shot.duration}ç§’
Sora2æç¤ºè¯ï¼š${shot.scene}ï¼Œ${shot.action}ï¼Œ${shot.visual}ï¼Œæç¬‘é£æ ¼ï¼Œå•†å“å±•ç¤ºï¼Œ${currentEcommerceScript.product}ï¼Œé«˜è´¨é‡æ¸²æŸ“

`;
            });

            navigator.clipboard.writeText(soraScript).then(() => {
                showMessage(`Sora2å¸¦è´§è„šæœ¬å·²å¤åˆ¶ (${currentEcommerceScript.shots.length}ä¸ªåˆ†é•œ)`, 'success');
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // å¤åˆ¶ç”µå•†åˆ†é•œ
        function copyEcommerceShots() {
            if (!currentEcommerceScript) {
                showMessage('è¯·å…ˆç”Ÿæˆå¸¦è´§æ–‡æ¡ˆ', 'error');
                return;
            }

            const shots = currentEcommerceScript.shots.map(shot =>
                `åˆ†é•œ${shot.number}ï¼š${shot.scene}
${shot.duration}ç§’ - ${shot.action}ï¼Œ${shot.product_show}ï¼Œ${shot.visual}`
            );

            navigator.clipboard.writeText(shots.join('\n\n')).then(() => {
                showMessage('ç”µå•†åˆ†é•œè„šæœ¬å·²å¤åˆ¶', 'success');
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // å¤åˆ¶æŒ‡å®šçš„å•ä¸ªç”µå•†åˆ†é•œ
        function copyEcommerceShot(shotNumber, buttonElement) {
            if (!currentEcommerceScript) {
                showMessage('è¯·å…ˆç”Ÿæˆå¸¦è´§æ–‡æ¡ˆ', 'error');
                return;
            }

            const shot = currentEcommerceScript.shots.find(s => s.number === shotNumber);
            if (!shot) {
                showMessage('æ‰¾ä¸åˆ°æŒ‡å®šçš„åˆ†é•œ', 'error');
                return;
            }

            // æ„å»ºSora2æ ¼å¼çš„åˆ†é•œæç¤ºè¯
            const soraPrompt = `åˆ†é•œ ${shotNumber}ï¼š${shot.scene}
æ—¶é•¿ï¼š${shot.duration}ç§’
åŠ¨ä½œï¼š${shot.action}
å¯¹è¯ï¼š${shot.dialogue}
å•†å“å±•ç¤ºï¼š${shot.product_show}
è§†è§‰æ•ˆæœï¼š${shot.visual}

Sora2æç¤ºè¯ï¼š${shot.scene}ï¼Œ${shot.action}ï¼Œ${shot.visual}ï¼Œæç¬‘é£æ ¼ï¼Œ${currentEcommerceScript.product}å±•ç¤ºï¼Œé«˜è´¨é‡æ¸²æŸ“ï¼Œ${shot.duration}ç§’è§†é¢‘`;

            navigator.clipboard.writeText(soraPrompt).then(() => {
                // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'âœ… å·²å¤åˆ¶';
                buttonElement.classList.add('copied');

                showMessage(`åˆ†é•œ ${shotNumber} å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, 'success');

                // 2ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);

            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // ============ ç¾å¦†æ•™ç¨‹å¸¦è´§åŠŸèƒ½ ============

        // ç”Ÿæˆç¾å¦†æ•™ç¨‹è„šæœ¬
        async function generateBeautyScript() {
            const keyword = document.getElementById('beautyKeyword').value.trim();
            const beautyType = document.getElementById('beautyType').value;
            const product = document.getElementById('beautyProduct').value.trim();
            const level = document.getElementById('beautyLevel').value;
            const duration = parseInt(document.getElementById('beautyDuration').value);

            if (!keyword) {
                showMessage('è¯·è¾“å…¥ç¾å¦†æ•™ç¨‹ä¸»é¢˜', 'error');
                return;
            }

            const provider = document.getElementById('apiProvider').value;
            if (provider !== 'local' && !apiConfig.apiKey) {
                showMessage('è¯·å…ˆé…ç½®API Key', 'error');
                return;
            }

            // ç¦ç”¨ç”ŸæˆæŒ‰é’®
            const generateBtn = document.querySelector('button[onclick="generateBeautyScript()"]');
            generateBtn.disabled = true;
            generateBtn.textContent = 'ğŸ’„ ç”Ÿæˆä¸­...';

            try {
                showMessage('æ­£åœ¨ç”Ÿæˆç¾å¦†æ•™ç¨‹...', 'info');

                let scriptData;
                if (provider === 'local') {
                    scriptData = generateMockBeautyScript(keyword, beautyType, product, level, duration);
                } else {
                    scriptData = await generateAIBeautyScript(keyword, beautyType, product, level, duration);
                }

                currentBeautyScript = scriptData;
                displayBeautyScript(scriptData);
                showMessage(`âœ… æˆåŠŸç”Ÿæˆç¾å¦†æ•™ç¨‹ï¼Œ${duration}ç§’å®Œç¾é€‚é…Sora2ï¼`, 'success');

            } catch (error) {
                console.error('ç¾å¦†æ•™ç¨‹ç”Ÿæˆå¤±è´¥:', error);
                showMessage(`âŒ ç”Ÿæˆå¤±è´¥ï¼š${error.message}`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                generateBtn.disabled = false;
                generateBtn.textContent = 'ğŸ’„ ç”Ÿæˆç¾å¦†æ•™ç¨‹';
            }
        }

        // AIç”Ÿæˆç¾å¦†æ•™ç¨‹è„šæœ¬
        async function generateAIBeautyScript(keyword, beautyType, product, level, duration) {
            const prompt = buildBeautyPrompt(keyword, beautyType, product, level, duration);

            console.log('ğŸ’„ å¼€å§‹AIç”Ÿæˆç¾å¦†æ•™ç¨‹:', { keyword, beautyType, product, level, duration });

            const response = await fetch(`${apiConfig.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiConfig.apiKey}`
                },
                body: JSON.stringify({
                    model: getChatModel(),
                    messages: [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¾å¦†æ•™ç¨‹å¯¼å¸ˆï¼Œæ“…é•¿åˆ›ä½œè¯¦ç»†ã€å®ç”¨ã€æ˜“äºç†è§£çš„åŒ–å¦†ã€å‘å‹ã€æŠ¤è‚¤æ•™ç¨‹å†…å®¹ã€‚'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 2500,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(`AIç”Ÿæˆå¤±è´¥ (${response.status}): ${error.error?.message || response.statusText}`);
            }

            const data = await response.json();
            const aiContent = data.choices?.[0]?.message?.content || '';

            if (!aiContent) {
                throw new Error('AIè¿”å›å†…å®¹ä¸ºç©º');
            }

            console.log('âœ… AIç¾å¦†æ•™ç¨‹ç”ŸæˆæˆåŠŸ:', aiContent.length, 'å­—ç¬¦');

            return parseBeautyScript(aiContent, keyword, beautyType, product, level, duration);
        }

        // æ„å»ºç¾å¦†æ•™ç¨‹AIæç¤ºè¯
        function buildBeautyPrompt(keyword, beautyType, product, level, duration) {
            const typeMap = {
                'makeup': 'åŒ–å¦†æ•™ç¨‹',
                'hair': 'å‘å‹æ•™ç¨‹',
                'skincare': 'æŠ¤è‚¤æ•™ç¨‹',
                'tools': 'ç¾å¦†å·¥å…·ä½¿ç”¨',
                'nails': 'ç¾ç”²æ•™ç¨‹',
                'eyebrows': 'çœ‰æ¯›ä¿®æ•´',
                'lips': 'å”‡å¦†æŠ€å·§'
            };

            const levelMap = {
                'beginner': 'æ–°æ‰‹å…¥é—¨',
                'intermediate': 'è¿›é˜¶æŠ€å·§',
                'advanced': 'ä¸“ä¸šå¦†å®¹'
            };

            const typeName = typeMap[beautyType] || 'åŒ–å¦†æ•™ç¨‹';
            const levelName = levelMap[level] || 'æ–°æ‰‹å…¥é—¨';

            return `è¯·ä¸º"${keyword}"è¿™ä¸ªä¸»é¢˜åˆ›ä½œä¸€ä¸ª${typeName}çš„è¯¦ç»†æ•™å­¦è§†é¢‘è„šæœ¬ã€‚

è¦æ±‚ï¼š
1. æ•™ç¨‹ä¸»é¢˜ï¼š${keyword}
2. æ•™ç¨‹ç±»å‹ï¼š${typeName}
3. éš¾åº¦ç­‰çº§ï¼š${levelName}
4. æ€»æ—¶é•¿ï¼š${duration}ç§’
5. å¸¦è´§äº§å“ï¼š${product || 'æ— ç‰¹å®šäº§å“'}

æ•™ç¨‹è¦æ±‚ï¼š
- æ­¥éª¤æ¸…æ™°ï¼Œæ˜“äºè·Ÿéš
- æ¯ä¸ªæ­¥éª¤éƒ½æœ‰è¯¦ç»†çš„æ“ä½œè¯´æ˜
- ä¸“ä¸šæœ¯è¯­è§£é‡Šç®€å•æ˜“æ‡‚
- è‡ªç„¶æ¤å…¥äº§å“ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
- é€‚åˆçŸ­è§†é¢‘å¹³å°å±•ç¤º

è¯·æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
{
  "title": "å¸å¼•çœ¼çƒçš„æ•™ç¨‹æ ‡é¢˜",
  "keyword": "${keyword}",
  "type": "${beautyType}",
  "level": "${level}",
  "totalDuration": ${duration},
  "overview": "æ•™ç¨‹æ¦‚è§ˆï¼Œ50å­—ä»¥å†…",
  "product": "${product || ''}",
  "steps": [
    {
      "stepNumber": 1,
      "title": "æ­¥éª¤æ ‡é¢˜",
      "duration": ç§’æ•°,
      "description": "è¯¦ç»†çš„æ­¥éª¤è¯´æ˜",
      "technique": "å…·ä½“æŠ€å·§è¦ç‚¹",
      "productUsed": "ä½¿ç”¨çš„äº§å“ï¼ˆå¦‚æœæœ‰ï¼‰",
      "visual": "è§†è§‰å±•ç¤ºè¯´æ˜",
      "tips": "å°è´´å£«æˆ–æ³¨æ„äº‹é¡¹"
    }
  ]
}

è¯·ç¡®ä¿å†…å®¹ä¸“ä¸šã€å®ç”¨ã€æ˜“äºç†è§£ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½èƒ½ç‹¬ç«‹æˆä¸ºä¸€ä¸ªæ¸…æ™°çš„æ•™å­¦ç‰‡æ®µã€‚`;

        }

        // è§£æAIç”Ÿæˆçš„ç¾å¦†æ•™ç¨‹
        function parseBeautyScript(aiContent, keyword, beautyType, product, level, duration) {
            try {
                // å°è¯•è§£æJSONæ ¼å¼
                let scriptData;
                if (aiContent.includes('{') && aiContent.includes('}')) {
                    const jsonMatch = aiContent.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        scriptData = JSON.parse(jsonMatch[0]);
                    }
                }

                // å¦‚æœJSONè§£æå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ
                if (!scriptData || !scriptData.steps) {
                    scriptData = generateMockBeautyScript(keyword, beautyType, product, level, duration);
                }

                return scriptData;
            } catch (error) {
                console.warn('JSONè§£æå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ:', error);
                return generateMockBeautyScript(keyword, beautyType, product, level, duration);
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿç¾å¦†æ•™ç¨‹è„šæœ¬
        function generateMockBeautyScript(keyword, beautyType, product, level, duration) {
            const stepCount = Math.max(3, Math.min(8, Math.floor(duration / 15))); // æ¯æ­¥15ç§’
            const avgDuration = Math.floor(duration / stepCount);

            const typeTemplates = {
                'makeup': {
                    overview: 'ä¸“ä¸šçš„æ—¥å¸¸å¦†å®¹æ•™ç¨‹ï¼Œè®©ä½ è½»æ¾æŒæ¡åŒ–å¦†æŠ€å·§',
                    steps: ['å¦†å‰å‡†å¤‡', 'åº•å¦†æ­¥éª¤', 'çœ¼å¦†æŠ€å·§', 'å”‡å¦†ç‚¹ç¼€', 'å®šå¦†æ”¶å°¾']
                },
                'hair': {
                    overview: 'ç®€å•æ˜“å­¦çš„å‘å‹æ•™ç¨‹ï¼Œæ‰“é€ å®Œç¾é€ å‹',
                    steps: ['å¤´å‘å‡†å¤‡', 'åˆ†åŒºå¤„ç†', 'æ ¸å¿ƒé€ å‹', 'ç»†èŠ‚è°ƒæ•´', 'å®šå‹å®Œæˆ']
                },
                'skincare': {
                    overview: 'ç§‘å­¦æŠ¤è‚¤æ­¥éª¤ï¼Œå‘µæŠ¤ä½ çš„è‚Œè‚¤',
                    steps: ['æ¸…æ´é¢éƒ¨', 'çˆ½è‚¤è°ƒç†', 'ç²¾åæŠ¤ç†', 'é¢éœœæ»‹æ¶¦', 'é˜²æ™’ä¿æŠ¤']
                },
                'tools': {
                    overview: 'ç¾å¦†å·¥å…·æ­£ç¡®ä½¿ç”¨æ–¹æ³•ï¼Œæå‡åŒ–å¦†æ•ˆæœ',
                    steps: ['å·¥å…·ä»‹ç»', 'æ­£ç¡®æ¡æ³•', 'ä½¿ç”¨æŠ€å·§', 'æ³¨æ„äº‹é¡¹', 'æ¸…æ´ä¿å…»']
                }
            };

            const template = typeTemplates[beautyType] || typeTemplates['makeup'];
            const stepTitles = template.steps.slice(0, stepCount);

            const steps = stepTitles.map((title, index) => {
                const stepDuration = index === stepCount - 1 ? duration - (avgDuration * (stepCount - 1)) : avgDuration;
                return {
                    stepNumber: index + 1,
                    title: title,
                    duration: stepDuration,
                    description: `è¯¦ç»†æ¼”ç¤º${title}çš„å…·ä½“æ“ä½œæ–¹æ³•`,
                    technique: `ä¸“ä¸š${title}æŠ€å·§ï¼Œè®©ä½ è½»æ¾æŒæ¡`,
                    productUsed: product && index === Math.floor(stepCount / 2) ? product : '',
                    visual: `æ¸…æ™°å±•ç¤º${title}çš„æ¯ä¸ªç»†èŠ‚ï¼Œç‰¹å†™é•œå¤´çªå‡ºé‡ç‚¹`,
                    tips: `${title}çš„å°è´´å£«ï¼Œè®©æ•ˆæœæ›´å¥½`
                };
            });

            return {
                title: `${keyword}å®Œæ•´æ•™ç¨‹`,
                keyword: keyword,
                type: beautyType,
                level: level,
                totalDuration: duration,
                overview: template.overview,
                product: product || '',
                steps: steps
            };
        }

        // æ˜¾ç¤ºç¾å¦†æ•™ç¨‹è„šæœ¬
        function displayBeautyScript(scriptData) {
            // æ˜¾ç¤ºæ•™ç¨‹æ¦‚è§ˆ
            const beautyOverview = document.getElementById('beautyOverview');
            beautyOverview.innerHTML = `
                <p><strong>ğŸ’„ æ•™ç¨‹ä¸»é¢˜ï¼š</strong>${scriptData.title}</p>
                <p><strong>ğŸ¯ æ•™ç¨‹ç±»å‹ï¼š</strong>${scriptData.type}</p>
                <p><strong>ğŸ“Š éš¾åº¦ç­‰çº§ï¼š</strong>${scriptData.level}</p>
                <p><strong>â±ï¸ æ€»æ—¶é•¿ï¼š</strong>${scriptData.totalDuration}ç§’</p>
                ${scriptData.product ? `<p><strong>ğŸ›’ å¸¦è´§äº§å“ï¼š</strong><span class="beauty-highlight">${scriptData.product}</span></p>` : ''}
                <p><strong>ğŸ“ æ•™ç¨‹æ¦‚è§ˆï¼š</strong>${scriptData.overview}</p>
            `;

            // æ˜¾ç¤ºæ­¥éª¤é¢„è§ˆ
            const beautyShotPreview = document.getElementById('beautyShotPreview');
            beautyShotPreview.innerHTML = scriptData.steps.map(step => `
                <div class="beauty-shot">
                    <div class="beauty-tag">æ­¥éª¤ ${step.stepNumber}</div>
                    <div class="shot-header">
                        <span class="step-number">${step.stepNumber}</span>
                        <span class="shot-duration">${step.duration}ç§’</span>
                    </div>
                    <h4>${step.title}</h4>
                    <p><strong>æ“ä½œè¯´æ˜ï¼š</strong>${step.description}</p>
                    <p><strong>æŠ€å·§è¦ç‚¹ï¼š</strong>${step.technique}</p>
                    ${step.productUsed ? `<p><strong>ä½¿ç”¨äº§å“ï¼š</strong><span class="beauty-highlight">${step.productUsed}</span></p>` : ''}
                    <p><strong>è§†è§‰å±•ç¤ºï¼š</strong>${step.visual}</p>
                    <p><strong>å°è´´å£«ï¼š</strong>${step.tips}</p>
                    <div class="shot-actions">
                        <button class="copy-shot-btn" onclick="copyBeautyStep(${step.stepNumber}, this)">
                            ğŸ“‹ å¤åˆ¶æ­¤æ­¥éª¤
                        </button>
                    </div>
                </div>
            `).join('');

            // æ˜¾ç¤ºå®Œæ•´æ•™ç¨‹è„šæœ¬
            const beautyScriptOutput = document.getElementById('beautyScriptOutput');
            let fullScript = `ç¾å¦†æ•™ç¨‹è„šæœ¬ - ${scriptData.title}
====================================

æ•™ç¨‹ä¸»é¢˜ï¼š${scriptData.title}
æ•™ç¨‹ç±»å‹ï¼š${scriptData.type}
éš¾åº¦ç­‰çº§ï¼š${scriptData.level}
æ€»æ—¶é•¿ï¼š${scriptData.totalDuration}ç§’
${scriptData.product ? `å¸¦è´§äº§å“ï¼š${scriptData.product}` : ''}
ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}

====================================

æ•™ç¨‹æ¦‚è§ˆï¼š${scriptData.overview}

====================================

è¯¦ç»†æ­¥éª¤ï¼š
`;

            scriptData.steps.forEach(step => {
                fullScript += `
æ­¥éª¤ ${step.stepNumber}ï¼š${step.title} (${step.duration}ç§’)
----------------------------------------
æ“ä½œè¯´æ˜ï¼š${step.description}
æŠ€å·§è¦ç‚¹ï¼š${step.technique}
${step.productUsed ? `ä½¿ç”¨äº§å“ï¼š${step.productUsed}` : ''}
è§†è§‰å±•ç¤ºï¼š${step.visual}
å°è´´å£«ï¼š${step.tips}

`;
            });

            beautyScriptOutput.textContent = fullScript;

            // æ˜¾ç¤ºè¾“å‡ºåŒºåŸŸ
            document.getElementById('beautyOutput').style.display = 'block';
            document.getElementById('beautyExportButtons').style.display = 'flex';
        }

        // å¤åˆ¶ç¾å¦†æ•™ç¨‹è„šæœ¬
        function copyBeautyScript() {
            const scriptText = document.getElementById('beautyScriptOutput').textContent;
            navigator.clipboard.writeText(scriptText).then(() => {
                showMessage('ç¾å¦†æ•™ç¨‹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // ä¸‹è½½ç¾å¦†æ•™ç¨‹è„šæœ¬
        function downloadBeautyScript() {
            const scriptText = document.getElementById('beautyScriptOutput').textContent;
            const blob = new Blob([scriptText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç¾å¦†æ•™ç¨‹è„šæœ¬_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showMessage('ç¾å¦†æ•™ç¨‹ä¸‹è½½æˆåŠŸ', 'success');
        }

        // å¯¼å‡ºSora2æ ¼å¼
        function exportBeautySora() {
            if (!currentBeautyScript) {
                showMessage('è¯·å…ˆç”Ÿæˆç¾å¦†æ•™ç¨‹', 'error');
                return;
            }

            let soraScript = `Sora2ç¾å¦†æ•™ç¨‹ - ${currentBeautyScript.title}
====================================
ç±»å‹ï¼š${currentBeautyScript.type}
æ—¶é•¿ï¼š${currentBeautyScript.totalDuration}ç§’
${currentBeautyScript.product ? `äº§å“ï¼š${currentBeautyScript.product}` : ''}

`;

            currentBeautyScript.steps.forEach((step, index) => {
                soraScript += `ã€æ­¥éª¤ ${step.stepNumber}/${currentBeautyScript.steps.length}ã€‘${step.title}
æ—¶é—´ï¼š${step.duration}ç§’
Sora2æç¤ºè¯ï¼š${step.description}ï¼Œ${step.visual}ï¼Œç¾å¦†æ•™ç¨‹ï¼Œ${step.productUsed}ï¼Œé«˜è´¨é‡æ¸²æŸ“ï¼Œè¯¦ç»†æ¼”ç¤º

`;
            });

            navigator.clipboard.writeText(soraScript).then(() => {
                showMessage(`Sora2ç¾å¦†æ•™ç¨‹è„šæœ¬å·²å¤åˆ¶ (${currentBeautyScript.steps.length}ä¸ªæ­¥éª¤)`, 'success');
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // å¤åˆ¶ç¾å¦†æ•™ç¨‹æ­¥éª¤
        function copyBeautyShots() {
            if (!currentBeautyScript) {
                showMessage('è¯·å…ˆç”Ÿæˆç¾å¦†æ•™ç¨‹', 'error');
                return;
            }

            const steps = currentBeautyScript.steps.map(step =>
                `æ­¥éª¤${step.stepNumber}ï¼š${step.title}
${step.duration}ç§’ - ${step.description}ï¼Œ${step.technique}ï¼Œ${step.visual}`
            );

            navigator.clipboard.writeText(steps.join('\n\n')).then(() => {
                showMessage('ç¾å¦†æ•™ç¨‹æ­¥éª¤å·²å¤åˆ¶', 'success');
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // å¤åˆ¶æŒ‡å®šçš„å•ä¸ªç¾å¦†æ•™ç¨‹æ­¥éª¤
        function copyBeautyStep(stepNumber, buttonElement) {
            if (!currentBeautyScript) {
                showMessage('è¯·å…ˆç”Ÿæˆç¾å¦†æ•™ç¨‹', 'error');
                return;
            }

            const step = currentBeautyScript.steps.find(s => s.stepNumber === stepNumber);
            if (!step) {
                showMessage('æ‰¾ä¸åˆ°æŒ‡å®šçš„æ­¥éª¤', 'error');
                return;
            }

            // æ„å»ºSora2æ ¼å¼çš„æ­¥éª¤æç¤ºè¯
            const soraPrompt = `æ­¥éª¤ ${stepNumber}ï¼š${step.title}
æ—¶é•¿ï¼š${step.duration}ç§’
æ“ä½œè¯´æ˜ï¼š${step.description}
æŠ€å·§è¦ç‚¹ï¼š${step.technique}
${step.productUsed ? `ä½¿ç”¨äº§å“ï¼š${step.productUsed}` : ''}
è§†è§‰å±•ç¤ºï¼š${step.visual}
å°è´´å£«ï¼š${step.tips}

Sora2æç¤ºè¯ï¼š${step.description}ï¼Œ${step.visual}ï¼Œç¾å¦†æ•™ç¨‹ï¼Œè¯¦ç»†æ¼”ç¤ºï¼Œ${step.productUsed}ï¼Œé«˜è´¨é‡æ¸²æŸ“ï¼Œ${step.duration}ç§’è§†é¢‘`;

            navigator.clipboard.writeText(soraPrompt).then(() => {
                // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'âœ… å·²å¤åˆ¶';
                buttonElement.classList.add('copied');

                showMessage(`æ­¥éª¤ ${stepNumber} å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, 'success');

                // 2ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);

            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

    </script>
</body>
</html>